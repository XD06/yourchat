<template>
    <!-- Ê∑ªÂä†Âä®ÊÄÅÁ±ª‰ª•ÊéßÂà∂‰æßËæπÊ†èÁä∂ÊÄÅ -->
    <div class="chat-view-container" :class="{ 'sidebar-collapsed': !isSidebarOpen && !isMobileView, 'mobile-sidebar-active': isMobileSidebarOpen }">
        <!-- Â∑¶‰æßÂûÇÁõ¥ÂõæÊ†áÊ†è (PCÁ´ØÊòæÁ§∫) -->
        <div class="icon-sidebar" v-if="!isMobileView">
            <div class="icon-item main-icon">
                <el-avatar :size="36" class="blue-avatar" style="background-color: transparent;">
                     <svg width="60" color = "white"  height="60" viewBox="0 0 41 41" fill="none" xmlns="http://www.w3.org/2000/svg" stroke-width="1.5" class="h-2/3 w-2/3 text-black dark:text-white"><path d="M37.5324 16.8707C37.9808 15.5241 38.1363 14.0974 37.9886 12.6859C37.8409 11.2744 37.3934 9.91076 36.676 8.68622C35.6126 6.83404 33.9882 5.3676 32.0373 4.4985C30.0864 3.62941 27.9098 3.40259 25.8215 3.85078C24.8796 2.7893 23.7219 1.94125 22.4257 1.36341C21.1295 0.785575 19.7249 0.491269 18.3058 0.500197C16.1708 0.495044 14.0893 1.16803 12.3614 2.42214C10.6335 3.67624 9.34853 5.44666 8.6917 7.47815C7.30085 7.76286 5.98686 8.3414 4.8377 9.17505C3.68854 10.0087 2.73073 11.0782 2.02839 12.312C0.956464 14.1591 0.498905 16.2988 0.721698 18.4228C0.944492 20.5467 1.83612 22.5449 3.268 24.1293C2.81966 25.4759 2.66413 26.9026 2.81182 28.3141C2.95951 29.7256 3.40701 31.0892 4.12437 32.3138C5.18791 34.1659 6.8123 35.6322 8.76321 36.5013C10.7141 37.3704 12.8907 37.5973 14.9789 37.1492C15.9208 38.2107 17.0786 39.0587 18.3747 39.6366C19.6709 40.2144 21.0755 40.5087 22.4946 40.4998C24.6307 40.5054 26.7133 39.8321 28.4418 38.5772C30.1704 37.3223 31.4556 35.5506 32.1119 33.5179C33.5027 33.2332 34.8167 32.6547 35.9659 31.821C37.115 30.9874 38.0728 29.9178 38.7752 28.684C39.8458 26.8371 40.3023 24.6979 40.0789 22.5748C39.8556 20.4517 38.9639 18.4544 37.5324 16.8707ZM22.4978 37.8849C20.7443 37.8874 19.0459 37.2733 17.6994 36.1501C17.7601 36.117 17.8666 36.0586 17.936 36.0161L25.9004 31.4156C26.1003 31.3019 26.2663 31.137 26.3813 30.9378C26.4964 30.7386 26.5563 30.5124 26.5549 30.2825V19.0542L29.9213 20.998C29.9389 21.0068 29.9541 21.0198 29.9656 21.0359C29.977 21.052 29.9842 21.0707 29.9867 21.0902V30.3889C29.9842 32.375 29.1946 34.2791 27.7909 35.6841C26.3872 37.0892 24.4838 37.8806 22.4978 37.8849ZM6.39227 31.0064C5.51397 29.4888 5.19742 27.7107 5.49804 25.9832C5.55718 26.0187 5.66048 26.0818 5.73461 26.1244L13.699 30.7248C13.8975 30.8408 14.1233 30.902 14.3532 30.902C14.583 30.902 14.8088 30.8408 15.0073 30.7248L24.731 25.1103V28.9979C24.7321 29.0177 24.7283 29.0376 24.7199 29.0556C24.7115 29.0736 24.6988 29.0893 24.6829 29.1012L16.6317 33.7497C14.9096 34.7416 12.8643 35.0097 10.9447 34.4954C9.02506 33.9811 7.38785 32.7263 6.39227 31.0064ZM4.29707 13.6194C5.17156 12.0998 6.55279 10.9364 8.19885 10.3327C8.19885 10.4013 8.19491 10.5228 8.19491 10.6071V19.808C8.19351 20.0378 8.25334 20.2638 8.36823 20.4629C8.48312 20.6619 8.64893 20.8267 8.84863 20.9404L18.5723 26.5542L15.206 28.4979C15.1894 28.5089 15.1703 28.5155 15.1505 28.5173C15.1307 28.5191 15.1107 28.516 15.0924 28.5082L7.04046 23.8557C5.32135 22.8601 4.06716 21.2235 3.55289 19.3046C3.03862 17.3858 3.30624 15.3413 4.29707 13.6194ZM31.955 20.0556L22.2312 14.4411L25.5976 12.4981C25.6142 12.4872 25.6333 12.4805 25.6531 12.4787C25.6729 12.4769 25.6928 12.4801 25.7111 12.4879L33.7631 17.1364C34.9967 17.849 36.0017 18.8982 36.6606 20.1613C37.3194 21.4244 37.6047 22.849 37.4832 24.2684C37.3617 25.6878 36.8382 27.0432 35.9743 28.1759C35.1103 29.3086 33.9415 30.1717 32.6047 30.6641C32.6047 30.5947 32.6047 30.4733 32.6047 30.3889V21.188C32.6066 20.9586 32.5474 20.7328 32.4332 20.5338C32.319 20.3348 32.154 20.1698 31.955 20.0556ZM35.3055 15.0128C35.2464 14.9765 35.1431 14.9142 35.069 14.8717L27.1045 10.2712C26.906 10.1554 26.6803 10.0943 26.4504 10.0943C26.2206 10.0943 25.9948 10.1554 25.7963 10.2712L16.0726 15.8858V11.9982C16.0715 11.9783 16.0753 11.9585 16.0837 11.9405C16.0921 11.9225 16.1048 11.9068 16.1207 11.8949L24.1719 7.25025C25.4053 6.53903 26.8158 6.19376 28.2383 6.25482C29.6608 6.31589 31.0364 6.78077 32.2044 7.59508C33.3723 8.40939 34.2842 9.53945 34.8334 10.8531C35.3826 12.1667 35.5464 13.6095 35.3055 15.0128ZM14.2424 21.9419L10.8752 19.9981C10.8576 19.9893 10.8423 19.9763 10.8309 19.9602C10.8195 19.9441 10.8122 19.9254 10.8098 19.9058V10.6071C10.8107 9.18295 11.2173 7.78848 11.9819 6.58696C12.7466 5.38544 13.8377 4.42659 15.1275 3.82264C16.4173 3.21869 17.8524 2.99464 19.2649 3.1767C20.6775 3.35876 22.0089 3.93941 23.1034 4.85067C23.0427 4.88379 22.937 4.94215 22.8668 4.98473L14.9024 9.58517C14.7025 9.69878 14.5366 9.86356 14.4215 10.0626C14.3065 10.2616 14.2466 10.4877 14.2479 10.7175L14.2424 21.9419ZM16.071 17.9991L20.4018 15.4978L24.7325 17.9975V22.9985L20.4018 25.4983L16.071 22.9985V17.9991Z" fill="currentColor"></path></svg>
                    <!-- <svg width="41" height="41" viewBox="0 0 41 41" fill="none" xmlns="http://www.w3.org/2000/svg" stroke-width="1.5" class="h-2/3 w-2/3 text-black dark:text-white"><path d="M37.5324 16.8707C37.9808 15.5241 38.1363 14.0974 37.9886 12.6859C37.8409 11.2744 37.3934 9.91076 36.676 8.68622C35.6126 6.83404 33.9882 5.3676 32.0373 4.4985C30.0864 3.62941 27.9098 3.40259 25.8215 3.85078C24.8796 2.7893 23.7219 1.94125 22.4257 1.36341C21.1295 0.785575 19.7249 0.491269 18.3058 0.500197C16.1708 0.495044 14.0893 1.16803 12.3614 2.42214C10.6335 3.67624 9.34853 5.44666 8.6917 7.47815C7.30085 7.76286 5.98686 8.3414 4.8377 9.17505C3.68854 10.0087 2.73073 11.0782 2.02839 12.312C0.956464 14.1591 0.498905 16.2988 0.721698 18.4228C0.944492 20.5467 1.83612 22.5449 3.268 24.1293C2.81966 25.4759 2.66413 26.9026 2.81182 28.3141C2.95951 29.7256 3.40701 31.0892 4.12437 32.3138C5.18791 34.1659 6.8123 35.6322 8.76321 36.5013C10.7141 37.3704 12.8907 37.5973 14.9789 37.1492C15.9208 38.2107 17.0786 39.0587 18.3747 39.6366C19.6709 40.2144 21.0755 40.5087 22.4946 40.4998C24.6307 40.5054 26.7133 39.8321 28.4418 38.5772C30.1704 37.3223 31.4556 35.5506 32.1119 33.5179C33.5027 33.2332 34.8167 32.6547 35.9659 31.821C37.115 30.9874 38.0728 29.9178 38.7752 28.684C39.8458 26.8371 40.3023 24.6979 40.0789 22.5748C39.8556 20.4517 38.9639 18.4544 37.5324 16.8707ZM22.4978 37.8849C20.7443 37.8874 19.0459 37.2733 17.6994 36.1501C17.7601 36.117 17.8666 36.0586 17.936 36.0161L25.9004 31.4156C26.1003 31.3019 26.2663 31.137 26.3813 30.9378C26.4964 30.7386 26.5563 30.5124 26.5549 30.2825V19.0542L29.9213 20.998C29.9389 21.0068 29.9541 21.0198 29.9656 21.0359C29.977 21.052 29.9842 21.0707 29.9867 21.0902V30.3889C29.9842 32.375 29.1946 34.2791 27.7909 35.6841C26.3872 37.0892 24.4838 37.8806 22.4978 37.8849ZM6.39227 31.0064C5.51397 29.4888 5.19742 27.7107 5.49804 25.9832C5.55718 26.0187 5.66048 26.0818 5.73461 26.1244L13.699 30.7248C13.8975 30.8408 14.1233 30.902 14.3532 30.902C14.583 30.902 14.8088 30.8408 15.0073 30.7248L24.731 25.1103V28.9979C24.7321 29.0177 24.7283 29.0376 24.7199 29.0556C24.7115 29.0736 24.6988 29.0893 24.6829 29.1012L16.6317 33.7497C14.9096 34.7416 12.8643 35.0097 10.9447 34.4954C9.02506 33.9811 7.38785 32.7263 6.39227 31.0064ZM4.29707 13.6194C5.17156 12.0998 6.55279 10.9364 8.19885 10.3327C8.19885 10.4013 8.19491 10.5228 8.19491 10.6071V19.808C8.19351 20.0378 8.25334 20.2638 8.36823 20.4629C8.48312 20.6619 8.64893 20.8267 8.84863 20.9404L18.5723 26.5542L15.206 28.4979C15.1894 28.5089 15.1703 28.5155 15.1505 28.5173C15.1307 28.5191 15.1107 28.516 15.0924 28.5082L7.04046 23.8557C5.32135 22.8601 4.06716 21.2235 3.55289 19.3046C3.03862 17.3858 3.30624 15.3413 4.29707 13.6194ZM31.955 20.0556L22.2312 14.4411L25.5976 12.4981C25.6142 12.4872 25.6333 12.4805 25.6531 12.4787C25.6729 12.4769 25.6928 12.4801 25.7111 12.4879L33.7631 17.1364C34.9967 17.849 36.0017 18.8982 36.6606 20.1613C37.3194 21.4244 37.6047 22.849 37.4832 24.2684C37.3617 25.6878 36.8382 27.0432 35.9743 28.1759C35.1103 29.3086 33.9415 30.1717 32.6047 30.6641C32.6047 30.5947 32.6047 30.4733 32.6047 30.3889V21.188C32.6066 20.9586 32.5474 20.7328 32.4332 20.5338C32.319 20.3348 32.154 20.1698 31.955 20.0556ZM35.3055 15.0128C35.2464 14.9765 35.1431 14.9142 35.069 14.8717L27.1045 10.2712C26.906 10.1554 26.6803 10.0943 26.4504 10.0943C26.2206 10.0943 25.9948 10.1554 25.7963 10.2712L16.0726 15.8858V11.9982C16.0715 11.9783 16.0753 11.9585 16.0837 11.9405C16.0921 11.9225 16.1048 11.9068 16.1207 11.8949L24.1719 7.25025C25.4053 6.53903 26.8158 6.19376 28.2383 6.25482C29.6608 6.31589 31.0364 6.78077 32.2044 7.59508C33.3723 8.40939 34.2842 9.53945 34.8334 10.8531C35.3826 12.1667 35.5464 13.6095 35.3055 15.0128ZM14.2424 21.9419L10.8752 19.9981C10.8576 19.9893 10.8423 19.9763 10.8309 19.9602C10.8195 19.9441 10.8122 19.9254 10.8098 19.9058V10.6071C10.8107 9.18295 11.2173 7.78848 11.9819 6.58696C12.7466 5.38544 13.8377 4.42659 15.1275 3.82264C16.4173 3.21869 17.8524 2.99464 19.2649 3.1767C20.6775 3.35876 22.0089 3.93941 23.1034 4.85067C23.0427 4.88379 22.937 4.94215 22.8668 4.98473L14.9024 9.58517C14.7025 9.69878 14.5366 9.86356 14.4215 10.0626C14.3065 10.2616 14.2466 10.4877 14.2479 10.7175L14.2424 21.9419ZM16.071 17.9991L20.4018 15.4978L24.7325 17.9975V22.9985L20.4018 25.4983L16.071 22.9985V17.9991Z" fill="currentColor"></path></svg> -->
                </el-avatar>
            </div>
            <div class="icon-item">
                <el-icon><ChatRound /></el-icon>
            </div>
            <div class="icon-item">
                <el-icon><Refresh /></el-icon>
            </div>
           
            <div class="icon-item">
                <el-icon><Setting /></el-icon>
            </div>
           
         
            <div class="icon-item" style = "background-color: grey; border-radius: 100%;height: 20px;width: 20px;">
                <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="20" height="20" viewBox="0 0 30 30">
    <path d="M15,3C8.373,3,3,8.373,3,15c0,5.623,3.872,10.328,9.092,11.63C12.036,26.468,12,26.28,12,26.047v-2.051 c-0.487,0-1.303,0-1.508,0c-0.821,0-1.551-0.353-1.905-1.009c-0.393-0.729-0.461-1.844-1.435-2.526 c-0.289-0.227-0.069-0.486,0.264-0.451c0.615,0.174,1.125,0.596,1.605,1.222c0.478,0.627,0.703,0.769,1.596,0.769 c0.433,0,1.081-0.025,1.691-0.121c0.328-0.833,0.895-1.6,1.588-1.962c-3.996-0.411-5.903-2.399-5.903-5.098 c0-1.162,0.495-2.286,1.336-3.233C9.053,10.647,8.706,8.73,9.435,8c1.798,0,2.885,1.166,3.146,1.481C13.477,9.174,14.461,9,15.495,9 c1.036,0,2.024,0.174,2.922,0.483C18.675,9.17,19.763,8,21.565,8c0.732,0.731,0.381,2.656,0.102,3.594 c0.836,0.945,1.328,2.066,1.328,3.226c0,2.697-1.904,4.684-5.894,5.097C18.199,20.49,19,22.1,19,23.313v2.734 c0,0.104-0.023,0.179-0.035,0.268C23.641,24.676,27,20.236,27,15C27,8.373,21.627,3,15,3z"></path>
                    </svg>
                </div>
               
            <!-- Ê∑ªÂä†Êî∂Ëµ∑/Â±ïÂºÄ‰æßËæπÊ†èÁöÑÊåâÈíÆ -->
            <div class="icon-item" @click="toggleSidebar">
                <el-icon>
                    <Fold v-if="isSidebarOpen" />
                    <Expand v-else />
                </el-icon>
            </div>
             <!-- Ê∑ªÂä†ÊöóÈªëÊ®°ÂºèÂàáÊç¢ÊåâÈíÆ -->
            
            <div class="icon-item bottom-icon">
                <el-icon><User /></el-icon>
            </div>
            <div style="background-color: transparent;" class="icon-item dark-mode-toggle" @click="toggleDarkMode">
                <div class="toggle-icon-wrapper">
                    <img style="height: 35px;width: 55px;" v-if="settingsStore.isDarkMode" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAACXBIWXMAAAsTAAALEwEAmpwYAAACxUlEQVR4nO2ZsW7UQBCGLUBQ5IAGkVQgKACJBwEKoDp0BSgSUFnyyf5/Wy6dIlAgIhFCROAZkE48AUgkkPAUhBAQUJIiSQManSUsZy/n89msgfmk7daend+7szNjx1EURVEURVEURVEURRlCFEVHSXYAPAfwnuQ3krskf/7hsZvaXpO1yJpc1205dRGG4RSARQBbFpwtNGRtssZutztZmeOe5x0hOUPyh20HRxiy1hlZ+1jOAzhB8nUDHCq7I97Kzi3lvO/7FwGsN8QRWcdjAJeiKDpPciJJksNxHJ8ieRXAAwCbg54VX0ZyvtvtTjbBeQAbAG632+2Dw9Ysc4IguGkSIvXl5ChnfsW28yR7ZaJ6eku9MIiwXCgmsB/wbDv/KEmSA05J5FkA8wYR7u/7YBiGUw2I9r1xnM+KkN8JAHZ83z878CEAi7bPfJXJTHocPufsPBs4GZaTHAl4TsWQvJWzsWUUmWTHsvPrRaL9qCRJcsiwC27smYh+Pm1NALnnq3Y+49vDnK2lPZNIrtkUIAiCyzUKcC1n751JgO+Wj8C5ugRIM8asra8mlXZsClBnKZsmd1l72ypAHv7vR4D/cBAMw/D60CAIy9cggIW6BCA5V+Qa7NgUgOTHuhIhAF9yYrf3THRdt2U7FSZ5p2oBSE7nbEixN9HIYojkJ6lJqnLe87xj+a9v3P7ZTlADyuGXFZbDvdy7t0meaXxDBMB8BQ2RBcO7ZwtlTQCWbYsgO6HMcYjj+Ljhy8t4I43Uv60pugngbpHbIS17pw1nXt7zoXBTtKFt8Q2ST0heAXBBbiz5miRPp0nOnMnx0m3x7I8RAK9sCzDGWBn7N5nXr6Tu2a4WRxwS7WcLn/kiSDdVGooNSJb2G3KFLw296sbBdd2W9NQAPAWwKpWVjd0hNlPbq+la2gMzPEVRFEVRFEVRFEVRFOc3vwCXaQF84pJv4AAAAABJRU5ErkJggg==" alt="toggle-on" class="toggle-switch">
                    <img style="height: 35px;width: 55px;" v-else src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAACXBIWXMAAAsTAAALEwEAmpwYAAADUElEQVR4nO1ZTU8UQRAdNMoB9WSExI9EDkriD0E8apZwNEA4kMxm5r1dOC4x6MlgUFD0NxDiP9BEUVB/hIgkftyUBOGiqTCapenZ7fkEtV7SyWbTU+9VT3d1VY3nKRQKhUKhUCgUCoVCoVC0Qb1eP0lyCMATAG9IfiG5Q/JnyWMn4l4VLaJpfHz8hFcUarVaD4B5AJsH4KzTEG2isVqtdufmuO/7nSSnSH4/aAcTDNE6JdozOQ/gNMnnh8ChtDvilezcVM4HQXAFwFqM4TUAswD66/X6ZZJdMuS3/EfyfotnN2RepjfjeV4CvjXxJZHxarXaHWPwA4CblUrlaDsbMgfAMIB12yJMTEycy7IACfnElzNJzvyyxflFWfWkwiQyA1iy2HvXaDSOp3E2DR+Al04xgbsBz3z4rud5HRl0dQCYsSzCrQw2E/MBuNPyqVqt1mOJ9osZnW8WtefNANianJy8kINtV77tIAh6Y58AMG+e+TTbvs323HNGATzKy74LH8nHsRkejCRHAl7eokiOGBzfiszgLHybVj6SQ2bkdIn2SSE2o531hysMwxt587TiIzm4byJ28+nmBZgtShSAB4aghaK4nPlIrhoL0F+UIJIDZsZWFJeNj+Rr26SvhqhLRQmKssdmQZ+K4rLxAfi8bxKA7eZJRQYmsW0swI+iuJz5UOIC+L5/qswFcOLj/34EaATBMAyvFiUoDMNrZQZBk88aBGFcg1JiFiWI5FxZ2aCNL+4aHCorEbKkp9fz5mnFB6ASlzdvGhOH8xYEYLTMVNjki4q9LqdiCMB6nuKiemPDEPQwL/uOfAstO0E0ymEpKfMohxuNxhEATw3bWwDOZ7XtyifXH8mLaRoiM1kWIRJzz7QrXGltpuSbbvuw7/ud0j6yLMJSmuMQbUPzTch4OzY2diytkyn4Xji34KoxTdEomo4kaIqOWs6gjI9hGJ7Nw2EXPgDvnZuiLm3xqDssJeYAgD7ZGdEt0hdVXnO27uxv5/Noi7vypWqLN38YAfAsxpG/YSxn/kzm77bJb5vF0iEfEu2nc227B0HQKw3Fw/xxNLrCF9pedTnU1oOSvwNYkcrqIHaHcEbcK5GWSp4dbIVCoVAoFAqFQqFQKBTeP4tff/4aZ9FqC+MAAAAASUVORK5CYII=" alt="toggle-off" class="toggle-switch">
                </div>
            </div>
        
        </div>
        
        <!-- Â∑¶‰æßËæπÊ†è - ÈáçÊñ∞ËÆæËÆ°ÔºåÊ®°‰ªøÊà™ÂõæÈ£éÊ†º -->
        <div class="sidebar" :class="{'sidebar-open-mobile': isMobileSidebarOpen}">
            <!-- È°∂ÈÉ®ÊêúÁ¥¢Âå∫Âüü -->
            <div class="sidebar-header">
                <div class="app-title">
                    <div class="mac-controls">
                        <span class="mac-btn mac-close"></span>
                        <span class="mac-btn mac-minimize"></span>
                        <span class="mac-btn mac-expand"></span>
                    </div>
                </div>
                <el-input
                    placeholder="Search"
                    prefix-icon="Search"
                    size="small"
                    class="search-input"
                />
                <div class="new-chat-wrapper">
                    <el-button type="primary" @click="handleNewChat" class="new-chat-btn" dark>
                        <el-icon><Plus /></el-icon>
                        <span>New Chat</span>
                        <el-icon><Edit /></el-icon>
                    </el-button>
                </div>
                
                <!-- ÁßªÂä®Á´Ø‰∏ìÁî®ÂäüËÉΩÊåâÈíÆÂå∫Âüü -->
                <div class="mobile-actions" v-if="isMobileView">
                    <el-button class="mobile-action-btn theme-btn" @click="toggleDarkMode" title="Toggle Dark Mode">
                        <el-icon><Moon v-if="settingsStore.isDarkMode" /><Sunny v-else /></el-icon>
                    </el-button>
                    <el-button class="mobile-action-btn settings-btn" @click="toggleSettings" title="Settings">
                        <el-icon><Setting /></el-icon>
                    </el-button>
                </div>
            </div>
            
            <!-- Êî∂ËóèÁöÑËÅäÂ§© -->
            <div class="saved-chats">
                <div class="sidebar-label">
                    <el-icon><Star /></el-icon>
                    <span>Saved</span>
                </div>
                <div class="chat-item saved" @click="handleChatItemClick('saved')">
                    <div class="chat-icon" style="background-color: #6366f1;">C</div>
                    <span class="chat-title">ChatAI</span>
                    <el-button class="more-btn" type="text">
                        <el-icon><MoreFilled /></el-icon>
                    </el-button>
                </div>
            </div>
            
            <!-- ÊåâÊó•ÊúüÂàÜÁªÑÁöÑÂéÜÂè≤ËÅäÂ§© -->
            <div class="history-group">
                <div class="sidebar-label">
                    <span>Today</span>
                    <el-icon class="expand-icon"><ArrowDown /></el-icon>
                </div>
                
                <!-- ÂΩìÂâç‰ºöËØù -->
                <div class="chat-item" 
                     :class="{ 'active': historyStore.activeId === 'current' }" 
                     @click="handleChatItemClick('current')">
                    <div class="chat-icon" style="background-color: #06b6d4;">
                        <el-icon><ChatRound /></el-icon>
                    </div>
                    <span class="chat-title">{{ currentSessionTitle }}</span>
                    <el-dropdown trigger="click" @command="(cmd) => handleCurrentChatAction(cmd)">
                        <el-button class="more-btn" type="text" @click.stop>
                        <el-icon><MoreFilled /></el-icon>
                    </el-button>
                        <template #dropdown>
                            <el-dropdown-menu>
                                <el-dropdown-item command="export">
                                    <el-icon><Download /></el-icon>ÂØºÂá∫ÂØπËØù
                                </el-dropdown-item>
                                <el-dropdown-item command="clear" divided>
                                    <el-icon><Delete /></el-icon>Ê∏ÖÁ©∫ÂØπËØù
                                </el-dropdown-item>
                            </el-dropdown-menu>
                        </template>
                    </el-dropdown>
                </div>
                
                <!-- ÂéÜÂè≤‰ºöËØù - ËøáÊª§ÊéâÂΩìÂâçÊ¥ªË∑ÉÁöÑ‰ºöËØù -->
                <template v-if="historyStore.getAllRecords.length > 0">
                    <div v-for="chat in historyStore.getAllRecords" 
                        :key="chat.id" 
                        class="chat-item"
                        :class="{ 'active': historyStore.activeId === chat.id }"
                        @click="handleChatItemClick(chat.id)"
                    >
                        <div class="chat-icon" :style="{ backgroundColor: getRandomColor(chat.id) }">
                            {{ chat.title.charAt(0) }}
                        </div>
                        <span class="chat-title">{{ chat.title }}</span>
                        <el-dropdown trigger="click" @command="(cmd) => handleHistoryAction(cmd, chat)">
                        <el-button 
                            class="more-btn" 
                            type="text"
                            @click.stop
                        >
                            <el-icon><MoreFilled /></el-icon>
                        </el-button>
                            <template #dropdown>
                                <el-dropdown-menu>
                                    <el-dropdown-item command="export">
                                        <el-icon><Download /></el-icon>ÂØºÂá∫ÂØπËØù
                                    </el-dropdown-item>
                                    <el-dropdown-item command="delete" divided>
                                        <el-icon><Delete /></el-icon>Âà†Èô§ÂØπËØù
                                    </el-dropdown-item>
                                </el-dropdown-menu>
                            </template>
                        </el-dropdown>
                    </div>
                </template>
                <div v-else class="empty-history">
                    <p>No saved conversations yet</p>
                </div>
            </div>
        </div>

        <!-- ÁßªÂä®Á´ØÈÅÆÁΩ©Â±Ç -->
        <div class="mobile-sidebar-overlay" :class="{active: isMobileSidebarOpen}" @click="toggleMobileSidebar"></div>

        <!-- Âè≥‰æß‰∏ªËÅäÂ§©Âå∫Âüü -->
        <div class="main-chat-area">
            <!-- ËÅäÂ§©Â§¥ÈÉ® - ÈáçÊñ∞ËÆæËÆ°ÔºåÊõ¥ÁÆÄÊ¥Å -->
            <div class="chat-header">
                <!-- ÁßªÂä®Á´ØÂ∑¶‰æßÊåâÈíÆÁªÑ -->
                <div class="header-left-actions" v-if="isMobileView">
                    <!-- ÁßªÂä®Á´ØÊ±âÂ†°ÊåâÈíÆÔºå‰ΩøÁî®Êñ∞ÂõæÊ†á -->
                    <button class="mobile-menu-button" @click="toggleMobileSidebar">
                    <svg style = "width: 20px ;height:auto;"data-v-a497a79e="" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024"><path fill="currentColor" d="M896 192H128v128h768zm0 256H384v128h512zm0 256H128v128h768zM320 384 128 512l192 128z"></path></svg>
                    </button>
                </div>
                
                <!-- Â∑¶‰æßÊ®°Âûã‰ø°ÊÅØÂíåÁä∂ÊÄÅÂå∫Âüü - Ê°åÈù¢Á´ØÊòæÁ§∫Âú®Â∑¶‰æßÔºåÁßªÂä®Á´ØÂ±Ö‰∏≠ -->
                <div class="header-left" :class="{'mobile-centered': isMobileView}">
                    <!-- Ê®°Âûã‰ø°ÊÅØÂíåËÆæÁΩÆ -->
                    <el-dropdown trigger="click" @command="handleModelChange">
                        <div class="model-info" style="cursor: pointer;">
                            <span class="model-name">{{ getModelDisplayName() }}</span>
                            <el-tag type="success" size="small" effect="dark" class="model-tag">
                                <div class="tag-content">
                                    <div class="status-indicator online"></div>
                                    <span>Online</span>
                                </div>
                            </el-tag>
                            <el-icon class="model-dropdown-icon"><ArrowDown /></el-icon>
                        </div>
                        <template #dropdown>
                            <el-dropdown-menu>
                                <el-dropdown-item 
                                    v-for="model in modelOptions" 
                                    :key="model.value" 
                                    :command="model.value"
                                    :class="{ 'is-active': settingsStore.model === model.value }"
                                >
                                    {{ model.label }}
                                    <el-icon v-if="settingsStore.model === model.value"><Check /></el-icon>
                                </el-dropdown-item>
                            </el-dropdown-menu>
                        </template>
                    </el-dropdown>
                </div>
                
                <!-- ‰∏≠Èó¥Ê†áÈ¢òÂå∫Âüü - Âè™Âú®PCÊòæÁ§∫ -->
                <div class="header-center" v-if="!isMobileView">
                    <div class="conversation-info">
                        <span class="conversation-title">{{ currentChatTitle || 'New Chat' }}</span>
                        <div class="conversation-stats">
                            <span class="stats-item">
                                <el-icon><ChatDotRound /></el-icon>
                                {{ totalMessages }} messages
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- Âè≥‰æßÂäüËÉΩÊåâÈíÆ -->
                <div class="header-actions" :class="{'mobile-right-actions': isMobileView}">
                    
                    
                    <el-button class="share-btn" type="default" @click="handleShare">
                        <span class="button-text">Share</span>
                        <img style="width: 20px; height: 20px;" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAACXBIWXMAAAsTAAALEwEAmpwYAAADQklEQVR4nO3cS4hOYRzH8e8Ycg255LYhFmo2kktJWFi6LOSSyG6QhYUFCyGLWVA0lBI1LpmkFBtWNCImt42NZGNlIxau4zJHp85keuuc9/X2PM/7P8/5ferZPj3n+fa+58w58x4QERERERERERERCWwMcAC4DpwE5oVegPwzGngOJMPGZ2CxNqk19tXEGBr3W7SeyruUE+RLZDvTBqwENgBzMOxGTpB0xGI60D/suH4ChzCqCkGu5RxfegFjTuxBRmRfv0lZosQehOyqMSlLlCoEuVgniKkoVQgyEXhZlihVCJKaDDxtIMopWqwqQYaiPLMepUpBShGlTEGmZffY1gIbgc1Njj3AV6vnFKtBRgKrgGNAH/ChgQ30MbqqHqQj+7p436IAtWMQWF3FIEuBW9kGJMZGd5WCTMkO+I+Bjc8bp6lIkE3ARwMbXjQGs3NZ1EFGAWcNbHYjI/qT+njgbhMb8xroBY4CncB2Xfa6uaf05D8i9GePmGfjzlTr97VCfUJGA/caDHEHWIF75mOEDNLbwEa8A9bj72rOfIxQQfY2sBG3s03zYVJZYoQI0gF8r7MR3dmjVl8ulyWG7yBtwIM6G3ECv9LQ38oSw3eQHXU24koWzad2YKAsMXwGaQfeFMz9ChhHGDfLEsNnkG0F8/4CFhHOzJqT+m/gCEb5CvKozkk8tPRcsgbYAszFMB9BFhTcRk+vuGY5XH90fAQ5XDDnOYdrj5KPIH0Fcy5xuPYouQ4yFviRM99bx2uPkusgywrmO+947VFyHWRnwXy7HK89Sq6DHC+Yb7njtUfJdZCiR7MzHK89Sq6D5P1mMQl4q6TUXAcpmq/N8dqjFDKINEBBjFEQYxTEGAUxRkGMURBjFMQYBTFGQYxREGMUxBgFMUZBjFEQYxQk8iAXcub65Hjd0XIdZF3OXD2O1x0tH0/4umr+t/exx5+rRcfXI9f5wNbs5cV6lm4giDRJQYxREGMUxBgFMUZBShSkymMg+/vJx0twFITmw6Svk12oIJgaZ0IG6TFwwInxkb4JIpjdBg44MT4OhgySvpDyoYGDToyOF8CEkEGGonRmX1/pVZcGXAX261dfIiIiIiIiIiIiQmh/AenAVRtFBnygAAAAAElFTkSuQmCC" alt="share-3">
                    </el-button>
                    <el-button class="config-btn" type="default" @click="toggleSettings" style="background-color: black;" v-if="!isMobileView">
                        <span style="color: white" class="button-text">Settings</span>
                        <el-icon style="color: white" ><Setting /></el-icon>
                    </el-button>
                    
                    <!-- ÁßªÈô§New‰∏ãÊãâÊåâÈíÆÔºåÂè™Âú®PCÁ´ØÊòæÁ§∫ -->
                </div>
            </div>
            
            <!-- Ê∑ªÂä†ÊªöÂä®Âà∞Â∫ïÈÉ®ÊåâÈíÆ -->
            <div 
                class="scroll-to-bottom-btn" 
                :class="{ 'visible': showScrollButton }"
                @click="() => scrollToBottom(true)"
            >
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="7 13 12 18 17 13"></polyline>
                    <polyline points="7 6 12 11 17 6"></polyline>
                </svg>
            </div>
            
            <!-- Ê∂àÊÅØÂÆπÂô® -->
            <div class="messages-container" ref="messagesContainer" @scroll="handleMessagesScroll">
                <template v-if="messages.length">
                    <chat-message 
                        v-for="message in messages" 
                        :key="message.id" 
                        :message="message"
                        :is-latest-message="isLatestAIMessage(message)"
                        @update="handleMessageUpdate" 
                        @delete="handleMessageDelete" 
                        @regenerate="handleRegenerate" 
                    />
                </template>
                <div v-else class="empty-state">
                    <div class="welcome-container">
                        <el-avatar :size="60" class="blue-avatar"style = "background:transparent">
                            <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="50" height="50" viewBox="0 0 50 50">
<path fill="black" d="M 25 1 A 2.5 2.5 0 0 0 22.509766 3.2851562 L 7.2539062 12.119141 A 2.5 2.5 0 0 0 6.5 12 A 2.5 2.5 0 0 0 5 16.498047 L 5 33.503906 A 2.5 2.5 0 0 0 6.5 38 A 2.5 2.5 0 0 0 7.2558594 37.882812 L 22.513672 46.716797 A 2.5 2.5 0 0 0 25 49 A 2.5 2.5 0 0 0 27.490234 46.714844 L 42.746094 37.880859 A 2.5 2.5 0 0 0 43.5 38 A 2.5 2.5 0 0 0 45 33.501953 L 45 16.496094 A 2.5 2.5 0 0 0 43.5 12 A 2.5 2.5 0 0 0 42.744141 12.117188 L 27.486328 3.2832031 A 2.5 2.5 0 0 0 25 1 z M 22.265625 5.7402344 L 15.130859 18.128906 L 8.9960938 14.578125 A 2.5 2.5 0 0 0 8.8027344 13.533203 L 22.265625 5.7402344 z M 27.734375 5.7402344 L 41.197266 13.533203 A 2.5 2.5 0 0 0 41.001953 14.580078 L 34.869141 18.128906 L 27.734375 5.7402344 z M 8.1347656 16.390625 L 14.134766 19.865234 L 15.136719 18.134766 L 23.519531 22.990234 C 23.939531 22.690234 24.45 22.5 25 22.5 C 25.55 22.5 26.060469 22.690234 26.480469 22.990234 L 34.863281 18.134766 L 35.865234 19.865234 L 41.867188 16.390625 A 2.5 2.5 0 0 0 43 16.947266 L 43 32.253906 L 35.869141 19.869141 L 27.470703 24.720703 C 27.480703 24.820703 27.5 24.91 27.5 25 C 27.5 26.02 26.88 26.899062 26 27.289062 L 26 37 L 40.275391 37 L 26.822266 44.789062 A 2.5 2.5 0 0 0 26 44.210938 L 26 37 L 24 37 L 24 44.210938 A 2.5 2.5 0 0 0 23.177734 44.789062 L 9.7246094 37 L 24 37 L 24 27.289062 C 23.12 26.899062 22.5 26.02 22.5 25 C 22.5 24.91 22.519297 24.820703 22.529297 24.720703 L 14.130859 19.869141 L 7 32.253906 L 7 16.949219 A 2.5 2.5 0 0 0 8.1347656 16.390625 z"></path>
</svg>
                </el-avatar>
                        <h1 class="welcome-title">Hi, there üëã</h1>
                        <p class="welcome-subtitle">Tell us what you need, and we'll handle the rest.</p>
                        
                        <!-- ‰ªªÂä°Âç°ÁâáÂå∫Âüü -->
                        <div class="task-cards">
                            <div class="task-card">
                                <div class="task-card-avatar">
                                    <el-avatar :size="36" style="background-color: #444;">S</el-avatar>
                                </div>
                                <div class="task-card-content">
                                    <div class="task-card-header">Data Assistant</div>
                                    <div class="task-card-description">
                                        Designed to help manage sales processes and maximize customer engagement.
                                    </div>
                                </div>
                            </div>
                            
                            <div class="task-suggestions">
                                <div class="task-item">
                                    <el-icon><Document /></el-icon>
                                    <span>Answer RFP documentation</span>
                                </div>
                                <div class="task-item">
                                    <el-icon><DataAnalysis /></el-icon>
                                    <span>Conduct a competitor analysis</span>
                                </div>
                                <div class="task-item">
                                    <el-icon><Message /></el-icon>
                                    <span>Provide feedback on communication</span>
                                </div>
                                
                                <div class="task-footer">
                                    <span>Tasks</span>
                                    <el-button type="text">View All</el-button>
                                </div>
                            </div>
                            
                            <div class="prompt-suggestion">
                                <div class="prompt-header">
                                    <div class="prompt-text">What are the key benefits of Product 1 that I should highlight to potential clients?</div>
                                    <el-button type="text" class="prompt-more">
                                        <el-icon><MoreFilled /></el-icon>
                                    </el-button>
                                </div>
                                <div class="prompt-footer">Suggested prompt</div>
                            </div>
                        </div>
                        
                        <!-- Âø´ÈÄüÊìç‰ΩúÊåâÈíÆ -->
                        <div class="quick-actions">
                            <el-button class="action-button">
                                <el-icon><Calendar /></el-icon>
                                Connect Calendar
                            </el-button>
                            <el-button class="action-button">
                                <el-icon><TrendCharts /></el-icon>
                                Demo Task
                            </el-button>
                            <el-button class="action-button">
                                <el-icon><Connection /></el-icon>
                                Browse Integrations
                            </el-button>
                            <el-button class="action-button">
                                <el-icon><Notebook /></el-icon>
                                Shared in Notes
                            </el-button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ËÅäÂ§©ËæìÂÖ•Ê°Ü -->
            <chat-input 
                ref="chatInputRef"
                :loading="isLoading" 
                @send="handleSend"
                @clear="handleClear"
                @role-selected="handleRoleSelected"
                @pause="handlePauseGeneration"
                class="modern-chat-input"
            />
            
            <!-- Â∫ïÈÉ®ÂÖçË¥£Â£∞Êòé -->
            <!-- <div class="disclaimer">
                Centra may display inaccurate info, so please double check the response. 
                <el-link type="primary">Your Privacy & Orbita GPT</el-link>
            </div> -->
        </div>

        <!-- ËÆæÁΩÆÂØπËØùÊ°Ü -->
        <el-dialog
            v-model="showSettings"
            title="Settings"
            width="400px"
            :close-on-click-modal="false"
            :show-close="true"
            destroy-on-close
            class="settings-dialog"
        >
            <el-form :model="settingsForm" label-position="top" class="settings-form">
                <!-- Removing dark mode section -->
                <!-- <el-divider content-position="left">Appearance</el-divider>
                <el-form-item label="Dark Mode">
                    <el-switch
                        v-model="settingsStore.isDarkMode"
                        @change="handleDarkModeChange"
                    />
                </el-form-item> -->
                
                <el-divider content-position="left">Model Configuration</el-divider>
                <el-form-item label="Model">
                    <el-select v-model="settingsForm.model" class="w-full">
                        <el-option
                            v-for="model in modelOptions"
                            :key="model.value"
                            :label="model.label"
                            :value="model.value"
                        />
                    </el-select>
                </el-form-item>

                <el-form-item label="Add Custom Model">
                    <div class="custom-model-input">
                        <el-input 
                            v-model="customModelInput" 
                            placeholder="Enter custom model name" 
                            class="custom-model-field"
                        />
                        <el-button 
                            type="primary" 
                            @click="addCustomModel" 
                            :disabled="!customModelInput.trim()"
                            size="default"
                        >
                            Add
                        </el-button>
                    </div>
                    <div class="form-item-tip">
                        Add your own model names to use with compatible API endpoints
                    </div>
                    
                    <!-- Show custom model tags if any exist -->
                    <div v-if="customModels.length > 0" class="custom-models-list">
                        <el-tag
                            v-for="(model, index) in customModels"
                            :key="index"
                            closable
                            @close="removeCustomModel(index)"
                            class="custom-model-tag"
                        >
                            {{ model.label }}
                        </el-tag>
                    </div>
                </el-form-item>

                <!-- Temperature slider stays as is -->
                <el-form-item label="Temperature">
                    <el-slider
                        v-model="settingsForm.temperature"
                        :min="0"
                        :max="1"
                        :step="0.1"
                        show-input
                    />
                </el-form-item>
                <el-form-item label="Max Tokens">
                    <el-input-number
                        v-model="settingsForm.maxTokens"
                        :min="1"
                        :max="4096"
                        :step="1"
                    />
                </el-form-item>
                <el-form-item label="Top P">
                    <el-slider
                        v-model="settingsForm.topP"
                        :min="0"
                        :max="1"
                        :step="0.1"
                        show-input
                    />
                </el-form-item>
                <el-form-item label="Top K">
                    <el-input-number
                        v-model="settingsForm.topK"
                        :min="1"
                        :max="100"
                        :step="1"
                    />
                </el-form-item>
                
                <el-divider content-position="left">API Credentials</el-divider>
                <el-form-item label="API Key" required>
                    <el-input
                        v-model="settingsForm.apiKey"
                        type="password"
                        show-password
                        placeholder="Enter your API Key"
                        :class="{ 'is-error': !settingsStore.actualApiKey }"
                    />
                    <div class="form-item-tip" v-if="!settingsStore.actualApiKey">
                        API Key is required - either enter here or set in environment variables
                    </div>
                    <div class="form-item-tip">
                        <strong>Your custom settings will be used instead of environment variables.</strong><br/>
                        Custom API Keys entered here are not saved to browser storage for security.
                        You'll need to re-enter them if the app is refreshed.
                    </div>
                </el-form-item>
                
                <el-form-item label="API Endpoint">
                    <el-input
                        v-model="settingsForm.apiEndpoint"
                        placeholder="API Endpoint URL"
                    />
                    <div class="form-item-tip">
                        Default: https://api.openai.com/v1/chat/completions
                    </div>
                    <div class="form-item-tip">
                        <strong>Your custom endpoint will be used instead of environment variables.</strong><br/>
                        Custom endpoints are not saved to browser storage for security.
                    </div>
                    <el-button 
                        type="primary" 
                        size="small" 
                        class="parse-models-btn" 
                        @click="parseModels"
                        :loading="isParsingModels"
                    >
                        Parse Available Models
                    </el-button>
                </el-form-item>
                
                <el-form-item label="Stream Response">
                    <el-switch
                        v-model="settingsForm.streamResponse"
                    />
                    <div class="form-item-tip">Show AI responses in real-time</div>
                </el-form-item>
                
                <el-form-item label="ÂΩìÂâçËßíËâ≤ÊèêÁ§∫ËØç" v-if="settingsStore.currentRole">
                    <div class="current-role-info">
                        <div class="role-name">{{ settingsStore.currentRole.name }}</div>
                        <div class="role-prompt">{{ settingsStore.currentRole.prompt }}</div>
                        <el-button 
                            type="text" 
                            @click="clearCurrentRole" 
                            size="small"
                        >
                            Ê∏ÖÈô§ÂΩìÂâçËßíËâ≤
                        </el-button>
                    </div>
                </el-form-item>
            </el-form>

            <template #footer>
                <div class="dialog-footer">
                    <el-button @click="showSettings = false">Cancel</el-button>
                    <el-button type="primary" @click="saveSettings">
                        Save
                    </el-button>
                </div>
            </template>
        </el-dialog>
    </div>
</template>

<script setup>
import { ref, computed, onMounted, onBeforeUnmount, onUnmounted, watch, nextTick, h } from 'vue'
import { useChatStore } from '../stores/chat'
import { useSettingsStore } from '../stores/settings'
import { useHistoryStore } from '../stores/history'
import { ElMessageBox, ElMessage } from 'element-plus'
import ChatMessage from '../components/ChatMessage.vue'
import ChatInput from '../components/ChatInput.vue'
import { ArrowDown, Menu, Check, ArrowLeft, Setting, Plus, Edit, Star, Search, MoreFilled, ChatRound, Share, User, Fold, Expand, Refresh, ChatDotRound, Clock, Moon, Sunny, Download, Delete } from '@element-plus/icons-vue'
import { v4 as uuidv4 } from 'uuid'
// ÂØºÂÖ• messageHandler Áî®‰∫éÂ§ÑÁêÜÊ∂àÊÅØ
import { messageHandler } from '../utils/messageHandler'
import { fetchModelList } from '../stores/settings'

// Áä∂ÊÄÅÁÆ°ÁêÜ
const chatStore = useChatStore()
const settingsStore = useSettingsStore()
const historyStore = useHistoryStore()

// ÁßªÂä®Á´ØÊ£ÄÊµã - ÊîπËøõÊ£ÄÊµãÊñπÊ≥ï
const isMobileView = ref(window.innerWidth <= 768)
const isMobileSidebarOpen = ref(false)

// ÁõëÂê¨Á™óÂè£Â§ßÂ∞èÂèòÂåñÊù•ÊîπÂèòÁßªÂä®Á´ØËßÜÂõæÁä∂ÊÄÅ
const handleResize = () => {
    isMobileView.value = window.innerWidth <= 768
    
    // ÂΩì‰ªéÁßªÂä®Á´ØÂàáÊç¢Âà∞Ê°åÈù¢Á´ØÊó∂ÔºåÁ°Æ‰øùsidebarÊ≠£Á°ÆÊòæÁ§∫
    if (!isMobileView.value) {
        isMobileSidebarOpen.value = false
    }
}

// ÁßªÂä®Á´Ø‰æßËæπÊ†èÂàáÊç¢
const toggleMobileSidebar = () => {
    isMobileSidebarOpen.value = !isMobileSidebarOpen.value
    // Ê∑ªÂä†/ÁßªÈô§bodyÁöÑoverflow‰ª•Èò≤Ê≠¢ËÉåÊôØÊªöÂä®
    if (isMobileSidebarOpen.value) {
        document.body.style.overflow = 'hidden'
    } else {
        document.body.style.overflow = ''
    }
}

// Ê∑ªÂä†Á™óÂè£Â§ßÂ∞èÂèòÂåñÁõëÂê¨
onMounted(() => {
    // Á™óÂè£Â§ßÂ∞è‰∫ã‰ª∂ÁõëÂê¨
    window.addEventListener('resize', handleResize);
    handleResize();
    
    // Migrate old chat history to new format if needed
    migrateOldChatHistory();
    
    // Load current chat
    const savedCurrentChat = localStorage.getItem('currentChat');
    if (savedCurrentChat) {
        try {
            const savedMessages = JSON.parse(savedCurrentChat);
            if (savedMessages.length > 0) {
                // Load messages to the chat store if we're in current session
                if (historyStore.isCurrentSession) {
                    chatStore.setMessages(savedMessages);
                }
                
                // Update the current session title
                updateCurrentSessionTitle(savedMessages);
            }
        } catch (e) {
            console.error('Âä†ËΩΩÂΩìÂâçËÅäÂ§©Â§±Ë¥•:', e);
            currentSessionTitle.value = 'Êñ∞ÂØπËØù';
            currentChatTitle.value = 'Êñ∞ÂØπËØù';
        }
    } else {
        currentSessionTitle.value = 'Êñ∞ÂØπËØù';
        currentChatTitle.value = 'Êñ∞ÂØπËØù';
    }
    
    // ÂàùÂßãÂåñÊªöÂä®Áä∂ÊÄÅ
    nextTick(() => {
        if (messagesContainer.value) {
            scrollToBottom();
            handleScroll();
        }
    });
})

// ÁßªÈô§ÁõëÂê¨
onBeforeUnmount(() => {
    window.removeEventListener('resize', handleResize)
    // Á°Æ‰øùbody overflowË¢´ËøòÂéü
    document.body.style.overflow = ''
    
    // Ê∏ÖÈô§ÊªöÂä®ÂÆöÊó∂Âô®
    if (scrollTimeout) {
        clearTimeout(scrollTimeout);
    }
})

const messages = computed(() => chatStore.messages)
const isLoading = computed(() => chatStore.isLoading)
const messagesContainer = ref(null)

const totalMessages = computed(() => chatStore.messages.length); // Add this line

// Ê∑ªÂä†‰∏Ä‰∏™Êõ¥Êñ∞Ëß¶ÂèëÂô®ÔºåÁî®‰∫éÂº∫Âà∂Êõ¥Êñ∞Ê®°ÂûãÂàóË°®
const modelOptionsLastUpdated = ref(Date.now())

// Ê∑ªÂä†Ê®°ÂûãÈÄâÈ°πÁöÑËÆ°ÁÆóÂ±ûÊÄßÔºå‰ª•Á°Æ‰øù‰∏ãÊãâËèúÂçïÂßãÁªàÊòæÁ§∫ÊúÄÊñ∞Êï∞ÊçÆ
const modelOptions = computed(() => {
    // ‰æùËµñ modelOptionsLastUpdated ‰ª•Á°Æ‰øùÂú®ÂÄºÊõ¥Êñ∞Êó∂ÈáçÊñ∞ËÆ°ÁÆó
    const _ = modelOptionsLastUpdated.value;
    return settingsStore.modelOptions;
})

// ‰æßËæπÊ†èÁä∂ÊÄÅ
const isSidebarOpen = ref(true) // ÈªòËÆ§ÊâìÂºÄ

// ËÆæÁΩÆÈù¢ÊùøÁä∂ÊÄÅ
const showSettings = ref(false)
const isParsingModels = ref(false)

// Ê∑ªÂä†Êú¨Âú∞Ë°®ÂçïÁä∂ÊÄÅÂØπË±°ÔºåÁî®‰∫éÂ§ÑÁêÜËÆæÁΩÆË°®ÂçïÁöÑÊï∞ÊçÆ
const settingsForm = ref({
    apiKey: '',
    apiEndpoint: '',
    model: '',
    temperature: 0.7,
    maxTokens: 1000,
    topP: 0.7,
    topK: 50,
    streamResponse: true,
    systemPrompt: ''
})

// ÂΩìËÆæÁΩÆÈù¢ÊùøÊâìÂºÄÊó∂ÔºåÂàùÂßãÂåñË°®ÂçïÊï∞ÊçÆ
const initSettingsForm = () => {
    settingsForm.value = {
        apiKey: settingsStore.displayApiKey,
        apiEndpoint: settingsStore.displayApiEndpoint,
        model: settingsStore.model,
        temperature: settingsStore.temperature,
        maxTokens: settingsStore.maxTokens,
        topP: settingsStore.topP,
        topK: settingsStore.topK,
        streamResponse: settingsStore.streamResponse
        // Â∑≤ÁßªÈô§ systemPrompt Â≠óÊÆµ
    }
}

// ÁõëÂê¨ËÆæÁΩÆÈù¢ÊùøÁöÑÊòæÁ§∫Áä∂ÊÄÅÔºåÊâìÂºÄÊó∂ÂàùÂßãÂåñË°®Âçï
watch(() => showSettings.value, (newValue) => {
    if (newValue) {
        initSettingsForm()
    }
})

// ËÅäÂ§©ÂéÜÂè≤ËÆ∞ÂΩï
// const chatHistory = ref([])
const currentChatTitle = ref('Êñ∞ÂØπËØù')
// ËøΩË∏™ÂΩìÂâçÊ¥ªË∑ÉÁöÑÂéÜÂè≤ËÆ∞ÂΩïID
// const activeHistoryId = ref('current')
historyStore.activeId
// Dedicated state for the "current, unsaved" session
const currentSessionMessages = ref([]); 
const currentSessionTitle = ref('Êñ∞ÂØπËØù'); // For SIDEBAR "Current Chat" ITEM's title

// Áî®‰∫é‰∏≠Êñ≠ËØ∑Ê±ÇÁöÑÊéßÂà∂Âô® - Á°Æ‰øùÂÆÉÂú®ÂÖ®Â±Ä‰ΩúÁî®Âüü‰∏≠ÂÆö‰πâ
const activeController = ref(null);

// ‰øùÂ≠òËÅäÂ§©ÂéÜÂè≤Âà∞localStorage
// const saveChatHistory = () => {
//   localStorage.setItem('chatHistory', JSON.stringify(chatHistory.value))
// }

// ÂèëÈÄÅÊ∂àÊÅØÊñπÊ≥ï
const handleSend = async (content) => {
  console.log('[ChatView] handleSend received content:', content ? content.substring(0, 50) + '...' : '(empty)');
  if (!content || !content.trim()) {
    console.warn('[ChatView] handleSend received empty content. Aborting.');
    return;
  }

  // If already loading, prevent sending another message
  if (chatStore.isLoading && !isStreamPaused.value) {
      ElMessage.warning('Â∑≤ÊúâÊ∂àÊÅØÊ≠£Âú®Â§ÑÁêÜ‰∏≠ÔºåËØ∑Á®çÂêéÂÜçËØï');
      return;
  }

  // If there's an active controller, abort it first
  if (activeController.value) {
    console.log('[ChatView] Aborting existing request before sending new message');
    activeController.value.abort();
    activeController.value = null;
    
    // Ê∏ÖÈô§‰πãÂâçÊ∂àÊÅØÁöÑÁä∂ÊÄÅ
    const lastMessage = chatStore.messages[chatStore.messages.length - 1];
    if (lastMessage && lastMessage.role === 'assistant' && !lastMessage.completed) {
      lastMessage.loading = false; 
      lastMessage.completed = true;
    }
  }
  
  let result = null; // Initialize result
  chatStore.isLoading = true; // Set loading state immediately

  try {
    // Add user message
    const userMessage = {
      id: Date.now(),
      role: 'user',
      content: content,
      timestamp: new Date().toISOString()
    };
    chatStore.addMessage(userMessage);
    console.log('[ChatView] User message added to store');
    
    // Add empty assistant message placeholder
    const assistantMessage = {
      id: Date.now(),
      role: 'assistant',
      content: '',
      thinkingContent: '', // Ensure this property is initialized
      timestamp: new Date().toISOString(),
      completed: false,
      loading: true // Ê∑ªÂä†loadingÁä∂ÊÄÅ
    };
    chatStore.addMessage(assistantMessage);
    console.log('[ChatView] Empty assistant message added to store');

    // Scroll to bottom after adding messages
    await nextTick();
    scrollToBottom(true);//ÂèëÈÄÅÊ∂àÊÅØÂêéÊªöÂä®Âà∞Â∫ïÈÉ®
    
    // Prepare messages for API
    const apiMessages = prepareMessagesForAPI();
    
    // Validate API messages
    if (apiMessages.length === 0) {
      console.error('[ChatView] Error: Prepared API messages are empty');
      ElMessage.error('Ê∂àÊÅØÂáÜÂ§áÂ§±Ë¥•: Ê∂àÊÅØ‰∏∫Á©∫');
      // No need to return, finally block handles isLoading
      throw new Error('Prepared API messages are empty'); 
    }

    // Check API Key
    if (!settingsStore.actualApiKey) {
      ElMessage.error('ËØ∑Âú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÊúâÊïàÁöÑAPI Key');
      showSettings.value = true;
      // No need to return, finally block handles isLoading
      throw new Error('API Key not configured');
    }

    // Call API
    result = await messageHandler.sendMessage(
        apiMessages,
        settingsStore.actualApiKey,
        settingsStore.actualApiEndpoint || 'https://api.openai.com/v1/chat/completions',
        {
          model: settingsStore.model,
          temperature: settingsStore.temperature,
          max_tokens: settingsStore.maxTokens,
          stream: settingsStore.streamResponse
        },
        (updatedContent, done) => {
          // Update message content
          const lastMessage = chatStore.messages[chatStore.messages.length - 1];
          if (lastMessage && lastMessage.role === 'assistant') {
            // Á¨¨‰∏ÄÊ¨°Êî∂Âà∞ÂÜÖÂÆπÊó∂ÁßªÈô§loadingÁä∂ÊÄÅ
            if (lastMessage.loading) {
              lastMessage.loading = false;
            }
            
            if (typeof updatedContent === 'object') {
              if (updatedContent.content !== undefined) {
                lastMessage.content = updatedContent.content;
              }
              if (updatedContent.thinkingContent !== undefined) {
                // Ensure thinkingContent property exists and is updated
                if (!lastMessage.thinkingContent) {
                  lastMessage.thinkingContent = '';
                }
                lastMessage.thinkingContent = updatedContent.thinkingContent;
                console.log('[ChatView] Updated thinking content:', updatedContent.thinkingContent.substring(0, 50));
              }
            } else if (updatedContent && updatedContent.length > 0) {
              lastMessage.content = updatedContent;
            }
            
            // Auto-scroll if content changed and user is near bottom
            if(isScrolledToBottom()) {
                nextTick(() => scrollToBottom(true));
            }

          } else {
            console.error('[ChatView Send] Cannot find assistant message to update');
          }
          
          if (done) {
            // Mark as complete and update tokens
            const lastMessage = chatStore.messages[chatStore.messages.length - 1];
            if (lastMessage && lastMessage.role === 'assistant') {
              lastMessage.completed = true;
              const promptTokens = messageHandler.countTokens(apiMessages.filter(m => m.role !== 'assistant').map(m => m.content).join(''));
              const finalContent = typeof updatedContent === 'object' ? updatedContent.content || '' : updatedContent || '';
              const completionTokens = messageHandler.countTokens(finalContent);
              chatStore.updateTokenCount(promptTokens, completionTokens);
              saveMessages();
            }
          }
        }
        // Note: isRegeneration defaults to false, no need to pass it explicitly here
      );
      
      // Save controller for potential abortion
      if (result?.controller) {
        activeController.value = result.controller;
      }
      
      // Handle non-aborted failures
      if (result && !result.success && !result.aborted) {
        ElMessage.error('Ê∂àÊÅØÂèëÈÄÅÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
        // Remove the placeholder assistant message
        const lastMessage = chatStore.messages[chatStore.messages.length - 1];
        if (lastMessage && lastMessage.role === 'assistant' && lastMessage.content === '') {
          chatStore.messages.pop();
        }
      }
  } catch (error) {
    console.error('[ChatView Send] Error:', error);
    // Avoid showing generic error if it's specific known issues handled above
    if (error.message !== 'Prepared API messages are empty' && error.message !== 'API Key not configured') {
        ElMessage.error(`Ê∂àÊÅØÂèëÈÄÅËøáÁ®ã‰∏≠ÂèëÁîüÈîôËØØÔºö${error.message || 'Êú™Áü•ÈîôËØØ'}`);
    }
    
    // Clean up placeholder message on error
    const lastMessage = chatStore.messages[chatStore.messages.length - 1];
    if (lastMessage && lastMessage.role === 'assistant' && lastMessage.content === '') {
      chatStore.messages.pop();
    }
  } finally {
    // ALWAYS reset loading state and controller (if not aborted)
    chatStore.isLoading = false;
    if (!result?.aborted && activeController.value) {
      activeController.value = null;
    }
    // If aborted, ensure controller is nullified if it wasn't already by the pause handler
    if (result?.aborted) {
         activeController.value = null; 
     }
  }
};

// Â§ÑÁêÜ‰ºöËØùÈ°πÁÇπÂáª
// src/views/ChatView.vue

// ... ÂÖ∂‰ªñ‰ª£Á†Å ...

// Â§ÑÁêÜ‰ºöËØùÈ°πÁÇπÂáª
const handleChatItemClick = (chatId) => {
  console.log(`[ChatView] Clicked on chat: ${chatId}`);
  
  // Add debug info
  historyStore.debugState();
  
  // If already the active chat, do nothing
  if (chatId === historyStore.activeId) {
    console.log('[ChatView] Already on this chat, ignoring click');
    return;
  }
  
  // Save current session messages if needed before switching
  if (historyStore.isCurrentSession && chatStore.messages.length > 0) {
    // Only save to localStorage, don't create a history record yet
    localStorage.setItem('currentChat', JSON.stringify(chatStore.messages));
    console.log('[ChatView] Saved current session to localStorage before switching');
  }
  
  // Switch to selected chat
  const success = historyStore.setActiveRecord(chatId);
  console.log(`[ChatView] setActiveRecord result: ${success ? 'success' : 'failed'}`);
  
  // Update UI title based on what we switched to
  if (chatId === 'current') {
    currentChatTitle.value = currentSessionTitle.value;
    console.log('[ChatView] Switched to current session with title:', currentSessionTitle.value);
  } else {
    const record = historyStore.getRecordById(chatId);
    if (record) {
      currentChatTitle.value = record.title;
      console.log('[ChatView] Switched to history record:', record.title);
    }
  }
};

// ... ÂÖ∂‰ªñ‰ª£Á†Å ...

// Â§ÑÁêÜÊñ∞Âª∫ÂØπËØù
const handleNewChat = () => {
  // Â¶ÇÊûúÂ∑≤ÁªèÊòØÁ©∫ÁöÑÂΩìÂâç‰ºöËØùÔºåÂàô‰∏çÂÅö‰ªª‰ΩïÂ§ÑÁêÜ
  if (historyStore.isCurrentSession && chatStore.messages.length === 0) {
    console.log('[ChatView] Already in empty session, no action needed');
    return;
  }
  
  // Â¶ÇÊûúÂΩìÂâçÊúâÊ∂àÊÅØ‰∏îÊòØÂΩìÂâç‰ºöËØùÔºåÂàô‰øùÂ≠òÂà∞ÂéÜÂè≤ËÆ∞ÂΩï
  if (chatStore.messages.length > 0 && historyStore.isCurrentSession) {
    const title = currentSessionTitle.value || 'Êñ∞ÂØπËØù';
    historyStore.saveCurrentAsHistory(title);
    console.log('[ChatView] Saved current session as history record:', title);
  } 
  // else: if viewing history, no need to save anything
  
  // Clear messages first
  chatStore.clearMessages();
  
  // Clear localStorage current chat
  localStorage.removeItem('currentChat');
  
  // Then switch to current (prevents loading from localStorage since we just removed it)
  historyStore.setActiveRecord('current');
  
  // Update UI state
  currentSessionMessages.value = [];
  currentSessionTitle.value = 'Êñ∞ÂØπËØù';
  currentChatTitle.value = 'Êñ∞ÂØπËØù';
  
  console.log('[ChatView] Created new empty chat');
  ElMessage.success('Â∑≤Êñ∞Âª∫ÂØπËØù');
}

// Â§ÑÁêÜÂéÜÂè≤ËÆ∞ÂΩïÊìç‰Ωú
// Â§ÑÁêÜÂéÜÂè≤ËÆ∞ÂΩïÊìç‰Ωú
// src/views/ChatView.vue

// ... ÂÖ∂‰ªñ‰ª£Á†Å ...

const handleHistoryAction = (command, chat) => {
  switch (command) {
    case 'export':
      if (chat && chat.id) {
        // Á°Æ‰øù‰º†ÈÄíÊï¥‰∏™chatÂØπË±°ÁªôexportChat
        exportChat(chat);
      } else {
        ElMessage.warning('Êó†Ê≥ïÂØºÂá∫ËØ•ÂØπËØùÔºåÊï∞ÊçÆ‰∏çÂÆåÊï¥');
        console.error('Export failed, invalid chat object:', chat);
      }
      break;
    case 'delete':
      // ÂÆûÁé∞Âà†Èô§ÂØπËØùÂäüËÉΩ
      handleDeleteChat(chat.id);
      break;
    default:
      console.log('Unknown command:', command);
  }
};

// ... ÂÖ∂‰ªñ‰ª£Á†Å ...
// ‰øùÂ≠òÊ∂àÊÅØ - Êõ¥Êñ∞‰∏∫‰ΩøÁî®Êñ∞ÁöÑÂéÜÂè≤ËÆ∞ÂΩïÁ≥ªÁªü
const saveMessages = () => {
  // Only save messages if we're in the current session
  if (historyStore.isCurrentSession) {
    // Save to localStorage for current session persistence
    localStorage.setItem('currentChat', JSON.stringify(chatStore.messages));
    
    // Update current session title
    updateCurrentSessionTitle(chatStore.messages);
  } else {
    // If we're viewing a history record, update it with any changes
    // Âú®Âè™ÊòØÊü•ÁúãËÄåÊ≤°ÊúâÂÆûÈôÖ‰øÆÊîπÂÜÖÂÆπÊó∂Ôºå‰∏çÊõ¥Êñ∞Êó∂Èó¥Êà≥ÔºåÈÅøÂÖçÊéíÂ∫èÂèòÂåñ
    historyStore.updateRecord(
      historyStore.activeId, 
      {
        messages: JSON.parse(JSON.stringify(chatStore.messages)),
        tokenCount: { ...chatStore.tokenCount }
      },
      false // ‰∏çÊõ¥Êñ∞Êó∂Èó¥Êà≥Ôºå‰øùÊåÅËÆ∞ÂΩïÂú®ÂàóË°®‰∏≠ÁöÑ‰ΩçÁΩÆ
    );
  }
};

// Êñ∞Â¢ûÔºöÂ§ÑÁêÜÂà∑Êñ∞ÊåâÈíÆÁÇπÂáª
const handleRefresh = () => {
    console.log('Âà∑Êñ∞ËÅäÂ§©');
    ElMessage.info('Âà∑Êñ∞ËÅäÂ§©ÂäüËÉΩÂ∑≤Ëß¶Âèë');
    // ÁÆÄÂçïÂÆûÁé∞ÔºöÊ∏ÖÁ©∫Ê∂àÊÅØÂàóË°®
    handleClear();
}

// Êñ∞Â¢ûÔºöÂ§ÑÁêÜÂàÜ‰∫´ÊåâÈíÆÁÇπÂáª
const handleShare = () => {
    console.log('ÂàÜ‰∫´ËÅäÂ§©');
    
    if (messages.value.length === 0) {
        ElMessage.warning('Ê≤°ÊúâÂèØÂàÜ‰∫´ÁöÑÂÜÖÂÆπ');
        return;
    }
    
    // Ê®°ÊãüÂàÜ‰∫´ÂäüËÉΩ
    try {
        const chatContent = messages.value.map(m => 
            `[${m.role}]: ${m.content}`
        ).join('\n\n');
        
        navigator.clipboard.writeText(chatContent)
            .then(() => {
                ElMessage.success('ÂØπËØùÂÜÖÂÆπÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
            })
            .catch(err => {
                console.error('Â§çÂà∂Â§±Ë¥•:', err);
                ElMessage.error('ÂàÜ‰∫´Â§±Ë¥•ÔºåÊó†Ê≥ïÂ§çÂà∂ÂÜÖÂÆπ');
            });
    } catch (error) {
        console.error('ÂàÜ‰∫´ÈîôËØØ:', error);
        ElMessage.error('ÂàÜ‰∫´ÂäüËÉΩÂá∫Èîô');
    }
}

// Ê∑ªÂä†isStreamPausedÁöÑÂÆö‰πâ
const isStreamPaused = ref(false);

// Â§ÑÁêÜÊöÇÂÅúÊ∂àÊÅØÁîüÊàê
const handlePauseGeneration = () => {
    console.log('[ChatView] handlePauseGeneration called');
  
    // ËÆæÁΩÆÊöÇÂÅúÁä∂ÊÄÅ
    isStreamPaused.value = true;
  
    // ÂèñÊ∂àËøõË°å‰∏≠ÁöÑËØ∑Ê±Ç
  if (activeController.value) {
        console.log('[ChatView] Aborting active request...');
    activeController.value.abort();
    activeController.value = null;
        console.log('[ChatView] Request aborted');
    }
    
    // Á´ãÂç≥Ê∏ÖÈô§Âä†ËΩΩÁä∂ÊÄÅ
    chatStore.isLoading = false;
    
    // Ê∏ÖÈô§‰ªª‰ΩïÊ≠£Âú®ÁîüÊàê‰∏≠ÁöÑÊ∂àÊÅØÁä∂ÊÄÅ
    const lastMessage = chatStore.messages[chatStore.messages.length - 1];
    if (lastMessage && lastMessage.role === 'assistant' && !lastMessage.completed) {
        // Â∞ÜÊú™ÂÆåÊàêÁöÑÊ∂àÊÅØÊ†áËÆ∞‰∏∫Â∑≤ÂÆåÊàêÔºå‰ª•ÂÅúÊ≠¢Âä†ËΩΩÂä®Áîª
        lastMessage.loading = false;
        lastMessage.completed = true;
        console.log('[ChatView] Marked last message as completed');
    }
    
    // ÊòæÁ§∫ÈÄöÁü•
    ElMessage({
        message: 'Â∑≤ÊöÇÂÅúÁîüÊàê',
        type: 'info',
        duration: 2000
    });
    
    // Ê∏ÖÈô§ÊöÇÂÅúÁä∂ÊÄÅÔºå‰ª•‰æø‰∏ãÊ¨°ËØ∑Ê±ÇÂèØ‰ª•Ê≠£Â∏∏ËøõË°å
    setTimeout(() => {
        isStreamPaused.value = false;
        console.log('[ChatView] Stream pause state reset');
    }, 500);
}

// ÊªöÂä®Âà∞Â∫ïÈÉ®ÁöÑËæÖÂä©ÂáΩÊï∞
const scrollToBottom = (forceScroll = false) => {
  if (messagesContainer.value) {
    const { scrollHeight, scrollTop, clientHeight } = messagesContainer.value;
    // ÂÆö‰πâ‰∏Ä‰∏™ÈòàÂÄºÔºàÂÉèÁ¥†ÔºâÔºåÁî®‰∫éÂà§Êñ≠Áî®Êà∑ÊòØÂê¶Êé•ËøëÂ∫ïÈÉ®
    const SCROLL_THRESHOLD = 250; // Â¢ûÂä†Âà∞250pxÔºå‰ΩøÂæóÊªöÂä®Ë∑üÈöèËåÉÂõ¥Êõ¥Â§ß
    // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶Âú®ÈòàÂÄºËåÉÂõ¥ÂÜÖÔºåÊàñËÄÖÊòØÂê¶Âº∫Âà∂ÊªöÂä®
    const isUserNearBottom = scrollHeight - scrollTop - clientHeight < SCROLL_THRESHOLD;

    if (forceScroll || isUserNearBottom) {
      messagesContainer.value.scrollTo({
        top: messagesContainer.value.scrollHeight,
        behavior: 'smooth'
      });
      // console.log('Â∑≤ÊªöÂä®Âà∞Â∫ïÈÉ®„ÄÇÂº∫Âà∂:', forceScroll, 'Áî®Êà∑Êé•ËøëÂ∫ïÈÉ®:', isUserNearBottom);
    } else {
      // console.log('Êú™ÊªöÂä®Âà∞Â∫ïÈÉ®ÔºåÁî®Êà∑‰∏çÂú®Â∫ïÈÉ®ÈôÑËøë„ÄÇ');
    }
  }
};

// Â§ÑÁêÜËßíËâ≤ÈÄâÊã©
const handleRoleSelected = (role) => {
  console.log('ÈÄâÊã©ËßíËâ≤:', role);
  // Â≠òÂÇ®ÂΩìÂâçÈÄâÊã©ÁöÑËßíËâ≤Âà∞ËÆæÁΩÆ‰∏≠
  settingsStore.currentRole = {
    name: role.name,
    prompt: role.prompt
  };
  // ‰∏çÈúÄË¶ÅÈáçÊñ∞ÂèëÈÄÅÊ∂àÊÅØÔºåÂè™ÈúÄË¶ÅÊõ¥Êñ∞Á≥ªÁªüÁä∂ÊÄÅ
  ElMessage.success({
    message: `Â∑≤ËÆæÁΩÆËßíËâ≤: ${role.name}`,
    description: 'ËØ•ËßíËâ≤ÊèêÁ§∫ËØçÂ∞Ü‰Ωú‰∏∫Á≥ªÁªüÊåá‰ª§ÂèëÈÄÅÁªôAIÔºåÂèñ‰ª£Á≥ªÁªüÊèêÁ§∫ËØçËÆæÁΩÆ'
  });
}

// ÂáÜÂ§áÂèëÈÄÅÁªôAPIÁöÑÊ∂àÊÅØ
const prepareMessagesForAPI = () => {
  // ÂàõÂª∫Ê∂àÊÅØÊï∞ÁªÑÁöÑÂâØÊú¨
  const apiMessages = [];
  
  // Ê∑ªÂä†Á≥ªÁªüÊèêÁ§∫ËØçÔºàÂ¶ÇÊûúÊúâÔºâ
  if (settingsStore.currentRole?.prompt) {
    // ‰ΩøÁî®ÂΩìÂâçËßíËâ≤ÁöÑÊèêÁ§∫ËØç‰Ωú‰∏∫Á≥ªÁªüÊèêÁ§∫
    apiMessages.push({
      role: 'system',
      content: settingsStore.currentRole.prompt
    });
  }
  
  // Ê∑ªÂä†ÊâÄÊúâÁöÑÁî®Êà∑ÂíåÂä©ÊâãÊ∂àÊÅØÔºå‰ΩÜËøáÊª§ÊéâÁ©∫Ê∂àÊÅØ
  messages.value.forEach(msg => {
    if ((msg.role === 'user' && msg.content.trim()) || 
        (msg.role === 'assistant' && msg.content.trim())) {
      apiMessages.push({
        role: msg.role,
        content: msg.content
      });
    }
  });
  
  return apiMessages;
}

// Ê∏ÖÈô§ÂΩìÂâçËßíËâ≤
const clearCurrentRole = () => {
  settingsStore.currentRole = null;
  ElMessage.success('Â∑≤Ê∏ÖÈô§ÂΩìÂâçËßíËâ≤ËÆæÁΩÆ');
}

// ‰øÆÊîπËá™Âä®‰øùÂ≠òÂΩìÂâçËÅäÂ§©ËÆ∞ÂΩïÊñπÊ≥ïÔºå‰ΩøÁî®saveMessagesÂáΩÊï∞
const autoSaveCurrentChat = () => {
  saveMessages();
}

// Âä†ËΩΩÂéÜÂè≤ÂØπËØù
// Â§ÑÁêÜÂΩìÂâçËÅäÂ§©ÁöÑÊìç‰Ωú

// Âà†Èô§ÂéÜÂè≤ÂØπËØù
// const handleDeleteChat = (chatId) => {
//   const indexToDelete = chatHistory.value.findIndex(chat => chat.id === chatId)
//   if (indexToDelete !== -1) {
//     const chatToDelete = chatHistory.value[indexToDelete]
//     ElMessage.success(`Â∑≤Âà†Èô§ÂØπËØù: ${chatToDelete.title}`)
//     chatHistory.value.splice(indexToDelete, 1)
    
//     // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÂΩìÂâçÊ¥ªË∑ÉÁöÑÂéÜÂè≤ËÆ∞ÂΩïÔºåÂàôÈáçÁΩÆ‰∏∫current
//     if (activeHistoryId.value === chatId) {
//       activeHistoryId.value = 'current'
//       chatStore.clearMessages()
//       currentChatTitle.value = 'Êñ∞ÂØπËØù'
//     }
    
//     saveChatHistory()
//   }
// }
// Âà†Èô§ÂéÜÂè≤ÂØπËØù
const handleDeleteChat = (chatId) => {
  // ‰ΩøÁî®historyStore APIÂà†Èô§ËÆ∞ÂΩï
  historyStore.deleteRecord(chatId);
  ElMessage.success('Â∑≤Âà†Èô§ÂØπËØù');
}
// ÂàáÊç¢‰æßËæπÊ†èÂáΩÊï∞
const toggleSidebar = () => {
  // Ëøô‰∏™ÂáΩÊï∞Áé∞Âú®‰∏ªË¶ÅÁî®‰∫éPCÁ´ØÁöÑ‰æßËæπÊ†èÊäòÂè†
  if (!isMobileView.value) {
    isSidebarOpen.value = !isSidebarOpen.value;
    showSettings.value = false; // Êî∂Ëµ∑ËæπÊ†èÊó∂ÂÖ≥Èó≠ËÆæÁΩÆÈù¢Êùø
  } else {
    // ÁßªÂä®Á´ØË∞ÉÁî®Êñ∞ÁöÑtoggleMobileSidebar
    toggleMobileSidebar();
  }
};

// ÂàáÊç¢ËÆæÁΩÆÈù¢Êùø
const toggleSettings = () => {
  showSettings.value = !showSettings.value
  console.log('Settings dialog toggled:', showSettings.value)
}

// ‰øùÂ≠òËÆæÁΩÆ
const saveSettings = () => {
  const customApiKey = settingsForm.value.apiKey;
  const customApiEndpoint = settingsForm.value.apiEndpoint;
  
  // Ê£ÄÊü•ÊòØÂê¶ÊúâËá™ÂÆö‰πâÂÄº
  const hasCustomValues = customApiKey || customApiEndpoint;
  
  // È™åËØÅAPI Key
  if (!customApiKey && !settingsStore.actualApiKey) {
    ElMessage.warning('API Key is required for the application to work');
    return;
  }
  
  // ‰øùÂ≠òÊâÄÊúâËÆæÁΩÆÂà∞ store
  settingsStore.temperature = settingsForm.value.temperature;
  settingsStore.maxTokens = settingsForm.value.maxTokens;
  settingsStore.model = settingsForm.value.model;
  settingsStore.topP = settingsForm.value.topP;
  settingsStore.topK = settingsForm.value.topK;
  settingsStore.streamResponse = settingsForm.value.streamResponse;
  // Â∑≤ÁßªÈô§ systemPrompt ÁöÑ‰øùÂ≠ò
  
  // Âº∫Âà∂Âà∑Êñ∞Ê®°ÂûãÈÄâÊã©Âô®ÊòæÁ§∫
  modelOptionsLastUpdated.value = Date.now();
  
  if (hasCustomValues) {
    // Áî®Êà∑Êèê‰æõ‰∫ÜËá™ÂÆö‰πâÂÄºÔºåÂêØÁî®Ëá™ÂÆö‰πâAPI
    settingsStore.setCustomAPI(customApiKey, customApiEndpoint);
    ElMessage.success('Â∑≤‰øùÂ≠òËá™ÂÆö‰πâAPIËÆæÁΩÆ');
  } else if (settingsStore.userCustomizedAPI) {
    // Áî®Êà∑Ê∏ÖÁ©∫‰∫ÜËá™ÂÆö‰πâÂÄºÔºåÂõûÈÄÄÂà∞ÁéØÂ¢ÉÂèòÈáè
    settingsStore.clearCustomAPI();
    ElMessage.success('Â∑≤ÊÅ¢Â§ç‰ΩøÁî®ÁéØÂ¢ÉÂèòÈáèAPIËÆæÁΩÆ');
  } else {
    // Ê≤°ÊúâÂèòÂåñÔºåÂè™ÊòØ‰øùÂ≠òÂÖ∂‰ªñËÆæÁΩÆ
    ElMessage.success('ËÆæÁΩÆÂ∑≤‰øùÂ≠ò');
  }
  
  // ‰øùÂ≠òËÆæÁΩÆÂêéÂÖ≥Èó≠ÂØπËØùÊ°Ü
  showSettings.value = false;
}

const handleDarkModeChange = (value) => {
  settingsStore.isDarkMode = value
}

// ÁõëÂê¨Ê∂àÊÅØÂèòÂåñÔºåËá™Âä®‰øùÂ≠ò
watch(messages, () => {
  saveMessages();
  
  nextTick(() => {
    if (messagesContainer.value) {
      // Ê£ÄÊü•ÊòØÂê¶Âú®Â∫ïÈÉ®ÊàñÊé•ËøëÂ∫ïÈÉ®ÔºåÂè™ÊúâÂú®Â∫ïÈÉ®Êó∂ÊâçËá™Âä®ÊªöÂä®
      if (isScrolledToBottom()) {
        scrollToBottom();
      } else {
        // Â¶ÇÊûú‰∏çÂú®Â∫ïÈÉ®ÔºåÊòæÁ§∫ÊªöÂä®Âà∞Â∫ïÈÉ®ÊåâÈíÆ
        showScrollButton.value = true;
      }
    }
  });
}, { deep: true });

// Âú®ÁªÑ‰ª∂ÊåÇËΩΩÊó∂Âä†ËΩΩ‰øùÂ≠òÁöÑÊ∂àÊÅØ
onMounted(() => {
  window.addEventListener('resize', handleResize);
  handleResize();
  
  // Âä†ËΩΩ‰øùÂ≠òÁöÑËÅäÂ§©ÂéÜÂè≤
  const savedHistory = localStorage.getItem('chatHistory');
  if (savedHistory) {
    try {
      chatHistory.value = JSON.parse(savedHistory);
    } catch (e) {
      console.error('Âä†ËΩΩËÅäÂ§©ÂéÜÂè≤Â§±Ë¥•:', e);
      chatHistory.value = [];
    }
  }
  
  // Âä†ËΩΩÂΩìÂâçËÅäÂ§©
  const savedCurrentChat = localStorage.getItem('currentChat');
  if (savedCurrentChat) {
    try {
      const savedMessages = JSON.parse(savedCurrentChat);
      if (savedMessages.length > 0) {
        chatStore.setMessages(savedMessages);
        
        // ÂàùÂßãÂåñÂΩìÂâç‰ºöËØùÁä∂ÊÄÅ
        currentSessionMessages.value = JSON.parse(JSON.stringify(savedMessages));
        
        // ËÆæÁΩÆÂΩìÂâç‰ºöËØùÊ†áÈ¢ò
        updateCurrentSessionTitle(savedMessages);
      }
    } catch (e) {
      console.error('Âä†ËΩΩÂΩìÂâçËÅäÂ§©Â§±Ë¥•:', e);
      
      // ÂàùÂßãÂåñÈªòËÆ§Áä∂ÊÄÅ
      currentSessionMessages.value = [];
      currentSessionTitle.value = 'Êñ∞ÂØπËØù';
      currentChatTitle.value = 'Êñ∞ÂØπËØù';
    }
  } else {
    // Â¶ÇÊûúÊ≤°Êúâ‰øùÂ≠òÁöÑÂΩìÂâçËÅäÂ§©ÔºåÂàùÂßãÂåñÈªòËÆ§Áä∂ÊÄÅ
    currentSessionMessages.value = [];
    currentSessionTitle.value = 'Êñ∞ÂØπËØù';
    currentChatTitle.value = 'Êñ∞ÂØπËØù';
  }
  
  // ÂàùÂßãÂåñÊªöÂä®Áä∂ÊÄÅ
  nextTick(() => {
    if (messagesContainer.value) {
      scrollToBottom();
      handleScroll();
    }
  });
});

// Watch for changes in chatStore.messages to update currentSessionTitle and currentSessionMessages
// ONLY when the current chat is active.
watch(() => chatStore.messages, (newMessages) => {
  // Only save to localStorage if we're in the current session
  if (historyStore.isCurrentSession) {
    console.log('[ChatView] Current session changed, saving to localStorage');
    localStorage.setItem('currentChat', JSON.stringify(newMessages));
    
    // Update currentSessionMessages and title
    currentSessionMessages.value = JSON.parse(JSON.stringify(newMessages));
    updateCurrentSessionTitle(newMessages);
  } else {
    console.log('[ChatView] History record changed, not saving to localStorage');
  }
  
  // Â§ÑÁêÜÊªöÂä®
  nextTick(() => {
    if (messagesContainer.value) {
      if (isScrolledToBottom()) {
        scrollToBottom();
      } else {
        showScrollButton.value = true;
      }
    }
  });
}, { deep: true });

// Êõ¥Êñ∞ÂΩìÂâç‰ºöËØùÊ†áÈ¢òÁöÑÂáΩÊï∞
const updateCurrentSessionTitle = (messages) => {
  if (!messages || messages.length === 0) {
    currentSessionTitle.value = 'Êñ∞ÂØπËØù';
    if (historyStore.isCurrentSession) {
      currentChatTitle.value = 'Êñ∞ÂØπËØù';
    }
    return;
  }
  
  // ‰ΩøÁî®Á¨¨‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØ‰Ωú‰∏∫Ê†áÈ¢ò
  const firstUserMsg = messages.find(m => m.role === 'user');
  if (!firstUserMsg) {
    currentSessionTitle.value = 'Êñ∞ÂØπËØù';
    if (historyStore.isCurrentSession) {
      currentChatTitle.value = 'Êñ∞ÂØπËØù';
    }
    return;
  }
  
  // ÂàõÂª∫Ê†áÈ¢ò
  const newTitle = firstUserMsg.content.length > 20 
    ? firstUserMsg.content.substring(0, 20) + '...' 
    : firstUserMsg.content;
    
  // Êõ¥Êñ∞Ê†áÈ¢ò
  currentSessionTitle.value = newTitle;
  
  // Â¶ÇÊûúÂΩìÂâç‰ºöËØùÊòØÊøÄÊ¥ªÁöÑÔºåÂêåÊó∂‰πüÊõ¥Êñ∞‰∏ªËÅäÂ§©Âå∫ÂüüÁöÑÊ†áÈ¢ò
  if (historyStore.isCurrentSession) {
    currentChatTitle.value = newTitle;
  }
  
  console.log('Êõ¥Êñ∞ÂΩìÂâç‰ºöËØùÊ†áÈ¢ò:', newTitle);
}

// ÁßªÈô§‰øùÂ≠òÊåâÈíÆÁõ∏ÂÖ≥ÁöÑÂáΩÊï∞ÔºåÊîπ‰∏∫Ëá™Âä®‰øùÂ≠ò
// ‰øùÂ≠òÂΩìÂâçÂØπËØù - Ëøô‰∏™ÊñπÊ≥ï‰∏çÂÜçÈúÄË¶ÅÔºå‰ΩÜ‰øùÁïô‰ª•‰æøÊâãÂä®Ëß¶Âèë
const saveCurrentChat = () => {
  autoSaveCurrentChat();
}

// Ëé∑ÂèñÊ®°ÂûãÊòæÁ§∫ÂêçÁß∞
const getModelDisplayName = () => {
    // Âº∫Âà∂Ê®°ÂûãÈÄâÈ°πÂà∑Êñ∞ÁöÑ‰æùËµñÈ°π
    const _ = modelOptionsLastUpdated.value;
    const model = settingsStore.model;
    const option = settingsStore.modelOptions.find(opt => opt.value === model);
    return option ? option.label : 'models';
}

// ‰∏∫ËÅäÂ§©È°πÁîüÊàêÈöèÊú∫È¢úËâ≤
const getRandomColor = (id) => {
    const colors = [
        '#4284f5', '#06b6d4', '#f59e0b', '#10b981', '#8b5cf6', '#ec4899', '#ef4444'
    ];
    // ‰ΩøÁî®id‰Ωú‰∏∫ÁßçÂ≠êÔºåÁ°Æ‰øùÂêå‰∏ÄidÊÄªÊòØÂæóÂà∞Áõ∏ÂêåÁöÑÈ¢úËâ≤
    const index = parseInt(id.toString().slice(-5)) % colors.length;
    return colors[index];
}

// Â§ÑÁêÜÊ®°ÂûãÂèòÊõ¥
const handleModelChange = (modelValue) => {
  // ËÆæÁΩÆÊñ∞ÈÄâÊã©ÁöÑÊ®°Âûã
  settingsStore.model = modelValue;
  // ÂêåÊ≠•Êõ¥Êñ∞ËÆæÁΩÆË°®Âçï‰∏≠ÁöÑÊ®°Âûã
  if (settingsForm.value) {
    settingsForm.value.model = modelValue;
  }
  // Âà∑Êñ∞Ê®°ÂûãÊòæÁ§∫
  modelOptionsLastUpdated.value = Date.now();
  ElMessage.success(`Ê®°ÂûãÂ∑≤ÂàáÊç¢‰∏∫: ${getModelDisplayName()}`);
}

// Ê∑ªÂä†Ê®°ÂûãËß£ÊûêÂäüËÉΩ
const parseModels = async () => {
    if (!settingsForm.value.apiKey && !settingsStore.actualApiKey) {
        ElMessage.warning('ËØ∑ÂÖàÂ°´ÂÜôAPI Key');
        return;
    }
    
    if (!settingsForm.value.apiEndpoint && !settingsStore.actualApiEndpoint) {
        ElMessage.warning('ËØ∑ÂÖàÂ°´ÂÜôAPI Endpoint');
        return;
    }
    
    isParsingModels.value = true;
    
    try {
        const apiKey = settingsForm.value.apiKey || settingsStore.actualApiKey;
        const apiEndpoint = settingsForm.value.apiEndpoint || settingsStore.actualApiEndpoint;
        
        const modelsList = await fetchModelList(
            apiEndpoint,
            apiKey
        );
        
        console.log('Fetched models:', modelsList);
        
        if (modelsList.length > 0) {
            // ‰ΩøÁî®storeÁöÑactionÊ∑ªÂä†Êñ∞Ê®°ÂûãÔºå‰º†ÂÖ•true‰Ωú‰∏∫Á¨¨‰∫å‰∏™ÂèÇÊï∞‰ª•Ê∏ÖÈô§Áé∞ÊúâÊ®°Âûã
            const addedCount = settingsStore.addModels(modelsList, true);
            
            // Êõ¥Êñ∞Êú¨Âú∞Ë°®Âçï‰∏≠ÁöÑÊ®°ÂûãÂàóË°®
            modelOptionsLastUpdated.value = Date.now();
            
            // Â¶ÇÊûúÂΩìÂâçÈÄâÊã©ÁöÑÊ®°ÂûãÂú®Êñ∞Ê®°ÂûãÂàóË°®‰∏≠‰∏çÂ≠òÂú®ÔºåÂàôËÆæÁΩÆ‰∏∫Á¨¨‰∏Ä‰∏™ÂèØÁî®Ê®°Âûã
            if (!modelsList.includes(settingsForm.value.model)) {
                settingsForm.value.model = modelsList[0];
            }
            
            ElMessage.success(`ÊàêÂäüËß£ÊûêÂà∞ ${modelsList.length} ‰∏™Ê®°ÂûãÔºåÂ∑≤Êõ¥Êñ∞Ê®°ÂûãÂàóË°®`);
        } else {
            ElMessage.info('Êú™Ëß£ÊûêÂà∞‰ªª‰ΩïÊ®°ÂûãÔºåËØ∑Ê£ÄÊü•APIÊé•Âè£ÊòØÂê¶Ê≠£Á°Æ');
        }
    } catch (error) {
        console.error('Ëß£ÊûêÊ®°ÂûãÂ§±Ë¥•:', error);
        ElMessage.error(`Ëß£ÊûêÊ®°ÂûãÂ§±Ë¥•ÔºÅÊ£ÄÊü•ÁΩëÁªúËøûÈÄöÊÄßÈáçËØï`);
    } finally {
        isParsingModels.value = false;
    }
}

// Â§ÑÁêÜÊöóÈªëÊ®°ÂºèÂàáÊç¢
const toggleDarkMode = () => {
  settingsStore.toggleDarkMode();
};

// Ê†ºÂºèÂåñÊó∂Èó¥Êà≥
const formatTimestamp = () => {
  const now = new Date();
  return `${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
}

// Â§ÑÁêÜÊªöÂä®Âà∞Â∫ïÈÉ®ÊåâÈíÆÁöÑÊòæÁ§∫
const showScrollButton = ref(false);
const scrollTimeout = ref(null);

// Âà§Êñ≠ÊòØÂê¶ÊªöÂä®Âà∞Â∫ïÈÉ®
const isScrolledToBottom = () => {
  if (!messagesContainer.value) return true;
  
  const { scrollTop, scrollHeight, clientHeight } = messagesContainer.value;
  // Êõ¥Êñ∞Ë∑ùÁ¶ªÂ∫ïÈÉ®ÁöÑÂÆπÂ∑ÆÂÄº‰∏∫250pxÔºå‰∏é‰∏äÈù¢ÊªöÂä®Ë∑üÈöèÈòàÂÄº‰øùÊåÅ‰∏ÄËá¥
  const tolerance = 250;
  return scrollHeight - scrollTop - clientHeight <= tolerance;
};

// Â§ÑÁêÜÊªöÂä®‰∫ã‰ª∂
const handleScroll = () => {
  if (!messagesContainer.value) return;
  
  // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®
  if (scrollTimeout.value) {
    clearTimeout(scrollTimeout.value);
  }
  
  // Âà§Êñ≠ÊòØÂê¶Â∑≤ÁªèÊªöÂä®Âà∞Â∫ïÈÉ®
  const atBottom = isScrolledToBottom();
  
  // Â¶ÇÊûúÊ≤°ÊúâÂú®Â∫ïÈÉ®ÔºåÊòæÁ§∫ÊåâÈíÆ
  if (!atBottom) {
    showScrollButton.value = true;
  } else {
    showScrollButton.value = false;
  }
  
  // ËÆæÁΩÆÂÆöÊó∂Âô®ÔºåÂ¶ÇÊûúÂú®1ÁßíÂÜÖÊ≤°ÊúâÁªßÁª≠ÊªöÂä®ÂàôÊ£ÄÊü•ÊòØÂê¶Âú®Â∫ïÈÉ®
  scrollTimeout.value = setTimeout(() => {
    // Âª∂ËøüÂêéÂÜçÊ¨°Ê£ÄÊü•ÊòØÂê¶Âú®Â∫ïÈÉ®
    if (isScrolledToBottom()) {
      showScrollButton.value = false;
    }
  }, 1000);
};

// Â§ÑÁêÜÊ∂àÊÅØÊõ¥Êñ∞
const handleMessageUpdate = (updatedMessage) => {
  const index = chatStore.messages.findIndex(m => m.id === updatedMessage.id);
  if (index !== -1) {
    chatStore.messages[index].content = updatedMessage.content;
    saveMessages();
  }
};

// Â§ÑÁêÜÊ∂àÊÅØÂà†Èô§
const handleMessageDelete = (message) => {
  const index = chatStore.messages.findIndex(m => m.id === message.id);
  if (index !== -1) {
    // ÁßªÈô§Ê∂àÊÅØ
    chatStore.messages.splice(index, 1);
    saveMessages();
  }
};

// Â§ÑÁêÜÈáçÊñ∞ÁîüÊàêAIÂìçÂ∫î
const handleRegenerate = async (messageToRegenerate) => {
  // 1. Validate the incoming message object and its ID
  if (!messageToRegenerate || typeof messageToRegenerate.id === 'undefined') {
    console.error('[ChatView] Regenerate called with invalid message object:', messageToRegenerate);
    ElMessage.warning('Êó†Ê≥ïÈáçÊñ∞ÁîüÊàêÔºöÊ∂àÊÅØÊï∞ÊçÆÊó†Êïà„ÄÇ');
    return;
  }
  const messageIdToRegenerate = messageToRegenerate.id;
  console.log(`[ChatView] Attempting to regenerate AI message ID: ${messageIdToRegenerate}`);
  
  if (chatStore.isLoading) {
    ElMessage.warning('Â∑≤ÊúâÊ∂àÊÅØÊ≠£Âú®Â§ÑÁêÜ‰∏≠ÔºåËØ∑Á®çÂêéÂÜçËØï');
    return;
  }
  
  let result = null; // Initialize result here to be accessible in finally block

  // 2. Take a snapshot of messages for historical context
  const messagesSnapshotForContext = [...chatStore.messages];

  // 3. Find the original AI message and preceding user message in the SNAPSHOT
  const aiMessageOriginalIndexInSnapshot = messagesSnapshotForContext.findIndex(m => m.id === messageIdToRegenerate && m.role === 'assistant');
  
  if (aiMessageOriginalIndexInSnapshot === -1) {
    console.error('[ChatView] Could not find the AI message to regenerate in the snapshot. Message ID:', messageIdToRegenerate);
    ElMessage.warning('ÈîôËØØÔºöÂú®Ê∂àÊÅØËÆ∞ÂΩïÂø´ÁÖß‰∏≠Êâæ‰∏çÂà∞Ë¶ÅÈáçÊñ∞ÁîüÊàêÁöÑAIÊ∂àÊÅØ„ÄÇ');
    return;
  }
  console.log('[ChatView] Found AI message in snapshot at index:', aiMessageOriginalIndexInSnapshot);

  let userMessageIndexInSnapshot = -1;
  for (let i = aiMessageOriginalIndexInSnapshot - 1; i >= 0; i--) {
    if (messagesSnapshotForContext[i].role === 'user') {
      userMessageIndexInSnapshot = i;
      break;
    }
  }
  
  if (userMessageIndexInSnapshot === -1) {
    // Fallback: find the latest user message in the snapshot if no direct preceding one
    const userMessagesInSnapshot = messagesSnapshotForContext.slice(0, aiMessageOriginalIndexInSnapshot).filter(m => m.role === 'user');
    if (userMessagesInSnapshot.length > 0) {
      const lastUserMessageInSnapshot = userMessagesInSnapshot[userMessagesInSnapshot.length - 1];
      userMessageIndexInSnapshot = messagesSnapshotForContext.findIndex(m => m.id === lastUserMessageInSnapshot.id);
    }
  }

  if (userMessageIndexInSnapshot === -1) {
    ElMessage.warning('Êó†Ê≥ïÊâæÂà∞Áõ∏ÂÖ≥ÁöÑÁî®Êà∑Ê∂àÊÅØ‰ª•ÈáçÊñ∞ÁîüÊàêÔºàÂü∫‰∫éÂø´ÁÖßÔºâ„ÄÇ');
    return;
  }
  const userMessageFromSnapshot = messagesSnapshotForContext[userMessageIndexInSnapshot];
  console.log('[ChatView] Found user message in snapshot:', userMessageFromSnapshot);
  
  try {
  chatStore.isLoading = true;
    // result is already declared above

    // 4. Re-find the AI message in the LIVE chatStore.messages array by ID before modification
    const liveAiMessageIndex = chatStore.messages.findIndex(m => m.id === messageIdToRegenerate && m.role === 'assistant');

    if (liveAiMessageIndex === -1) {
      console.error(`[ChatView] AI message ID ${messageIdToRegenerate} disappeared from live store before regeneration.`);
      ElMessage.warning('ÈîôËØØÔºöAIÊ∂àÊÅØÂú®ÂÆûÊó∂Êï∞ÊçÆ‰∏≠Ê∂àÂ§±ÔºåÊó†Ê≥ïÊõøÊç¢„ÄÇ');
      chatStore.isLoading = false;
      return;
    }
    console.log('[ChatView] Found AI message in live store at index:', liveAiMessageIndex);

    // 5. Splice the found AI message from the LIVE store
    chatStore.messages.splice(liveAiMessageIndex, 1);
    
    // 6. Add a new placeholder AI message to the LIVE store
    const newAssistantMessage = {
      id: Date.now(), // New ID for the new message
      role: 'assistant',
      content: '',
      thinkingContent: '', // Add thinkingContent to the regenerated message
      timestamp: new Date().toISOString(),
      completed: false,
      loading: true
    };
    chatStore.addMessage(newAssistantMessage);
    await nextTick();
    scrollToBottom(true);

    // 7. Construct apiMessages using the SNAPSHOT for historical accuracy
    const apiMessages = [];
    if (settingsStore.currentRole?.prompt) {
      apiMessages.push({ role: 'system', content: settingsStore.currentRole.prompt });
    }

    // Take messages from snapshot up to (but not including) the AI message that was meant to be regenerated
    const historyForApi = messagesSnapshotForContext.slice(0, aiMessageOriginalIndexInSnapshot);
    historyForApi.forEach(msg => {
      if ((msg.role === 'user' || msg.role === 'assistant') && msg.content.trim()) {
        apiMessages.push({ role: msg.role, content: msg.content });
      }
    });
    
    // Ensure the user message that prompted the original AI response is the last user message in the context
    const lastApiMessage = apiMessages.length > 0 ? apiMessages[apiMessages.length -1] : null;
    if (!lastApiMessage || lastApiMessage.role !== 'user' || lastApiMessage.content !== userMessageFromSnapshot.content) {
        // If the automatically collected history doesn't end with the correct user message,
        // ensure it's added. This primarily handles cases where the AI message was the first one after system prompt.
        if (userMessageFromSnapshot && userMessageFromSnapshot.content.trim()) {
             // Avoid duplicating if it was already the last one (e.g. if historyForApi was just system + user)
            if(!(apiMessages.length > 0 && apiMessages[apiMessages.length-1].role === 'user' && apiMessages[apiMessages.length-1].content === userMessageFromSnapshot.content)){
                apiMessages.push({ role: 'user', content: userMessageFromSnapshot.content });
            }
        }
    }

    console.log('[ChatView] Regenerating with API messages:', JSON.parse(JSON.stringify(apiMessages)));

    if (!settingsStore.actualApiKey) {
      ElMessage.error('ËØ∑Âú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÊúâÊïàÁöÑAPI Key');
      showSettings.value = true;
      throw new Error('API Key not configured');
    }
    if (apiMessages.filter(m => m.role ==='user').length === 0) {
      ElMessage.error('Êó†Ê≥ïÈáçÊñ∞ÁîüÊàêÔºåÂõ†‰∏∫Ê≤°ÊúâÊúâÊïàÁöÑÁî®Êà∑Ê∂àÊÅØ‰Ωú‰∏∫‰∏ä‰∏ãÊñá„ÄÇ');
      throw new Error('No valid user messages for regeneration context.');
    }
    
    result = await messageHandler.sendMessage(
      apiMessages,
      settingsStore.actualApiKey,
      settingsStore.actualApiEndpoint || 'https://api.openai.com/v1/chat/completions',
      {
        model: settingsStore.model,
        temperature: settingsStore.temperature,
        max_tokens: settingsStore.maxTokens,
        stream: settingsStore.streamResponse
      }, // Pass actual model settings
      (updatedContent, done) => {
        // Minimal update callback for regeneration
        const lastMessage = chatStore.messages[chatStore.messages.length - 1];
        if (lastMessage && lastMessage.role === 'assistant') {
          if (lastMessage.loading) {
            lastMessage.loading = false;
          }
          if (typeof updatedContent === 'object') {
            if (updatedContent.content !== undefined) {
              lastMessage.content = updatedContent.content;
            }
            // Handle thinking content update
            if (updatedContent.thinkingContent !== undefined) {
              // Ensure thinkingContent property exists
              if (!lastMessage.thinkingContent) {
                lastMessage.thinkingContent = '';
              }
              lastMessage.thinkingContent = updatedContent.thinkingContent;
            }
          } else if (typeof updatedContent === 'string') {
            lastMessage.content = updatedContent;
          }
          if (isScrolledToBottom()) {
            nextTick(() => scrollToBottom(true));
        }
        if (done) {
            lastMessage.completed = true;
            saveMessages(); // Save messages when regeneration is done
          }
        }
      },
      true // isRegeneration = true
    );
    
    if (result?.controller) {
        activeController.value = result.controller;
    }
    
    if (result && !result.success && !result.aborted) {
      ElMessage.error('ÈáçÊñ∞ÁîüÊàêÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
      const lastMessage = chatStore.messages[chatStore.messages.length - 1];
      if (lastMessage && lastMessage.role === 'assistant' && lastMessage.content === '') {
        chatStore.messages.pop(); // Clean up placeholder
      }
    }
    
  } catch (error) {
    console.error('[ChatView Regenerate] Error:', error);
    if (error.message !== 'API Key not configured' && error.message !== 'No valid user messages for regeneration context.') {
      ElMessage.error(`ÈáçÊñ∞ÁîüÊàêÊó∂ÂèëÁîüÈîôËØØ: ${error.message || 'Êú™Áü•ÈîôËØØ'}`);
    }
    // Clean up placeholder on any error during API call
    const lastMessage = chatStore.messages[chatStore.messages.length - 1];
    if (lastMessage && lastMessage.role === 'assistant' && lastMessage.content === '' && lastMessage.loading) {
      chatStore.messages.pop();
    }
  } finally {
    chatStore.isLoading = false;
    if (activeController.value && (!result || !result.aborted)) {
         activeController.value = null;
    }
     if (result?.aborted) {
         activeController.value = null; 
     }
  }
};

// Ê∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩï
const handleClear = () => {
  // Confirmation is now handled in ChatInput.vue
  chatStore.clearMessages();
  currentChatTitle.value = 'Êñ∞ÂØπËØù';
  ElMessage.success('ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤Ê∏ÖÁ©∫');
};

// ÊéßÂà∂ÊòØÂê¶ÊòæÁ§∫ËøîÂõûÈ°∂ÈÉ®ÊåâÈíÆ
const showScrollToTopButton = ref(false)

// Â§ÑÁêÜÊ∂àÊÅØÂÆπÂô®ÊªöÂä®‰∫ã‰ª∂
const handleMessagesScroll = () => {
  if (!messagesContainer.value) return
  
  // ÂΩìÊªöÂä®Ë∑ùÁ¶ªË∂ÖËøá500pxÊó∂ÊòæÁ§∫ËøîÂõûÈ°∂ÈÉ®ÊåâÈíÆ
  showScrollToTopButton.value = messagesContainer.value.scrollTop > 500
}

// ËøîÂõûÈ°∂ÈÉ®
const scrollToTop = () => {
  if (!messagesContainer.value) return
  
  messagesContainer.value.scrollTo({
    top: 0,
    behavior: 'smooth'
  })
}

// Âà§Êñ≠ÊòØÂê¶ÊòØÊúÄÂêé‰∏ÄÊù°AIÊ∂àÊÅØ
// Âà§Êñ≠ÊòØÂê¶ÊòØÊúÄÂêé‰∏ÄÊù°AIÊ∂àÊÅØ
const isLatestAIMessage = (message) => {
  // ËøáÊª§Âá∫ÊâÄÊúâAIÊ∂àÊÅØ
  const assistantMessages = chatStore.messages.filter(msg => msg.role === 'assistant');
  
  // Â¶ÇÊûúÊ≤°ÊúâAIÊ∂àÊÅØÊàñËÄÖÂΩìÂâçÊ∂àÊÅØ‰∏çÊòØAIÊ∂àÊÅØÔºåËøîÂõûfalse
  if (assistantMessages.length === 0 || message.role !== 'assistant') {
    return false;
  }
  
  // Âà§Êñ≠ÂΩìÂâçÊ∂àÊÅØÊòØÂê¶ÊòØÊúÄÂêé‰∏ÄÊù°AIÊ∂àÊÅØ
  const lastAssistantMessage = assistantMessages[assistantMessages.length - 1];
  return message.id === lastAssistantMessage.id;
}

// Â§ÑÁêÜÂΩìÂâçËÅäÂ§©ÁöÑÊìç‰Ωú
const handleCurrentChatAction = (command) => {
  switch (command) {
    case 'export':
      // ÂØºÂá∫ÂΩìÂâçËÅäÂ§©ËÆ∞ÂΩï
      if (chatStore.messages.length === 0) {
        ElMessage.warning('Ê≤°ÊúâÂèØÂØºÂá∫ÁöÑÂØπËØùÂÜÖÂÆπ');
        return;
      }
      const currentChat = {
  id: 'current',
  title: currentChatTitle.value,
  messages: JSON.parse(JSON.stringify(chatStore.messages)),
  roleData: settingsStore.currentRole ? {
    name: settingsStore.currentRole.name,
    prompt: settingsStore.currentRole.prompt
  } : null
};
exportChat(currentChat);
      break;
    case 'clear':
      // Á°ÆËÆ§ÊòØÂê¶Ê∏ÖÁ©∫ÂΩìÂâçËÅäÂ§©
      ElMessageBox.confirm(
        'Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÂΩìÂâçÂØπËØùÂêóÔºü',
        'Ê∏ÖÁ©∫Á°ÆËÆ§',
        {
          confirmButtonText: 'Á°ÆÂÆö',
          cancelButtonText: 'ÂèñÊ∂à',
          type: 'warning',
        }
      ).then(() => {
        chatStore.clearMessages();
        currentSessionTitle.value = 'Êñ∞ÂØπËØù';
        currentChatTitle.value = 'Êñ∞ÂØπËØù';
        ElMessage.success('Â∑≤Ê∏ÖÁ©∫ÂΩìÂâçÂØπËØù');
      }).catch(() => {
        // Áî®Êà∑ÂèñÊ∂àÊìç‰ΩúÔºå‰∏çÊâßË°å‰ªª‰ΩïÂä®‰Ωú
      });
      break;
    default:
      console.log('Êú™Áü•ÂëΩ‰ª§:', command);
  }
};

// ÂØºÂá∫ËÅäÂ§©ËÆ∞ÂΩïÂäüËÉΩ
const exportChat = (chat) => {
  // Ê£ÄÊü•ÂèÇÊï∞ÊòØÂê¶ÂêàÊ≥ï
  if (!chat || !chat.messages || !Array.isArray(chat.messages) || chat.messages.length === 0) {
    ElMessage.warning('Êó†Ê≥ïÂØºÂá∫ÔºöËÅäÂ§©ËÆ∞ÂΩï‰∏∫Á©∫ÊàñÊ†ºÂºè‰∏çÊ≠£Á°Æ');
    console.error('Export failed, invalid chat object:', chat);
    return;
  }

  // Êèê‰æõÊ†ºÂºèÈÄâÊã© - ‰ΩøÁî®Êõ¥ÂèãÂ•ΩÁöÑÈÄâÊã©Ê°Ü
  ElMessageBox({
    title: 'üìÑÂØºÂá∫ÂØπËØù',
    message: h('div', { class: 'export-format-selector' }, [
      h('p', { class: 'format-title' }, 'ÈÄâÊã©ÂØºÂá∫Ê†ºÂºè:'),
      h('div', { class: 'format-options' }, [
        h('div', { 
          class: 'format-option', 
          onClick: () => selectExportFormat(chat, '1'),
        }, [
          h('div', { class: 'format-icon txt-icon' }, 'TXT'),
          h('div', { class: 'format-label' }, 'Á∫ØÊñáÊú¨'),
          h('div', { class: 'format-desc' }, 'ÁÆÄÂçïÊñáÊú¨Ê†ºÂºèÔºåÈÄÇÂêà‰ªª‰ΩïËÆæÂ§áÊü•Áúã')
        ]),
        h('div', { 
          class: 'format-option', 
          onClick: () => selectExportFormat(chat, '2'),
        }, [
          h('div', { class: 'format-icon html-icon' }, 'HTML'),
          h('div', { class: 'format-label' }, 'ÁΩëÈ°µÊ†∑Âºè'),
          h('div', { class: 'format-desc' }, 'ÁæéËßÇÁöÑÁΩëÈ°µÊ†ºÂºèÔºåÈÄÇÂêàÂàÜ‰∫´ÂíåÊâìÂç∞')
        ]),
        h('div', { 
          class: 'format-option', 
          onClick: () => selectExportFormat(chat, '3'),
        }, [
          h('div', { class: 'format-icon md-icon' }, 'MD'),
          h('div', { class: 'format-label' }, 'Markdown'),
          h('div', { class: 'format-desc' }, 'Ê†áËÆ∞ËØ≠Ë®ÄÊ†ºÂºèÔºåÈÄÇÂêàÁºñËæëÂíåËΩ¨Êç¢')
        ]),
        h('div', { 
          class: 'format-option', 
          onClick: () => selectExportFormat(chat, '4'),
        }, [
          h('div', { class: 'format-icon json-icon' }, 'JSON'),
          h('div', { class: 'format-label' }, 'JSONÊï∞ÊçÆ'),
          h('div', { class: 'format-desc' }, 'ÂÆåÊï¥Êï∞ÊçÆÊ†ºÂºèÔºåÈÄÇÂêàÂºÄÂèëÂíåÂØºÂÖ•')
        ])
      ])
    ]),
    showCancelButton: true,
    confirmButtonText: 'ÂèñÊ∂à',
    cancelButtonText: 'ÂÖ≥Èó≠',
    showConfirmButton: false,
    customClass: 'export-format-dialog'
  }).catch(() => {
    // Áî®Êà∑ÂèñÊ∂àÂØºÂá∫
  });
};

// Ê†πÊçÆÈÄâÊã©ÁöÑÊ†ºÂºèÂ§ÑÁêÜÂØºÂá∫
const selectExportFormat = (chat, format) => {
  let exportContent = '';
  const dateStr = new Date().toLocaleString();
  const messages = chat.messages;
  const rolePrompt = chat.roleData?.prompt || '';

  switch(format) {
    case '1': // TXT Ê†ºÂºè
      exportContent = `‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ\n‚îÇ      AI Âä©ÊâãÂØπËØùËÆ∞ÂΩï         ‚îÇ\n‚îÇ ÂØºÂá∫Êó∂Èó¥: ${dateStr.padEnd(19)} ‚îÇ\n‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ\n\n`;
      
      // Ê∑ªÂä†ËßíËâ≤ËÆæÁΩÆ
      if (rolePrompt) {
        exportContent += `‚ï≠‚îÄ‚îÄ üí° ËßíËâ≤ËÆæÁΩÆ ‚îÄ‚îÄ\n‚îÇ\n‚îÇ ${rolePrompt.split('\n').join('\n‚îÇ ')}\n‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n`;
      }
      
      // Ê∑ªÂä†Ê∂àÊÅØÂÜÖÂÆπ
      messages.forEach(msg => {
        const role = msg.role === 'user' ? 'üë§ Áî®Êà∑' : 'ü§ñ AI';
        const time = msg.timestamp ? new Date(msg.timestamp).toLocaleString() : 'Êú™Áü•Êó∂Èó¥';

        exportContent += `\n‚ï≠‚îÄ‚îÄ ${role} ¬∑ ${time} ‚îÄ‚îÄ\n‚îÇ\n`;

        // ‰ºòÂÖàÊòæÁ§∫ÊÄùËÄÉÂÜÖÂÆπ
        if (msg.thinkingContent) {
          exportContent += `‚îÇ üí≠ ÊÄùËÄÉËøáÁ®ã:\n‚îÇ ${msg.thinkingContent.split('\n').join('\n‚îÇ ')}\n‚îÇ\n`;
        }

        exportContent += `‚îÇ üìù ÂÜÖÂÆπ:\n‚îÇ ${msg.content.split('\n').join('\n‚îÇ ')}\n‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
      });
      break;

    case '2': // HTML Ê†ºÂºè
      exportContent = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI ÂØπËØùËÆ∞ÂΩï - ${dateStr}</title>
  <style>
    :root {
      --primary-color: #4284f5;
      --primary-gradient: linear-gradient(135deg, #4284f5, #42a5f5);
      --secondary-color: #f5f7fa;
      --reasoning-color: #f39c12;
      --user-gradient: linear-gradient(135deg, #e74c3c, #f39c12, #2c7a65);
      --ai-gradient: linear-gradient(135deg, #4284f5, #0097a7);
      --card-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
      --border-radius: 12px;
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      line-height: 1.8;
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem;
      background: var(--secondary-color);
      color: #333;
    }

    .header {
      text-align: center;
      margin-bottom: 3rem;
      padding: 2.5rem;
      background: var(--primary-gradient);
      color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      position: relative;
      overflow: hidden;
    }
    
    .header::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0) 70%);
      transform: rotate(30deg);
      z-index: 1;
    }
    
    .header h1 {
      position: relative;
      z-index: 2;
      margin-bottom: 1rem;
      font-size: 2.5rem;
    }
    
    .header p {
      position: relative;
      z-index: 2;
      opacity: 0.9;
    }

    .role-section {
      margin-bottom: 2.5rem;
      padding: 1.8rem;
      background: rgba(66, 132, 245, 0.1);
      border-radius: var(--border-radius);
      border-left: 5px solid var(--primary-color);
      box-shadow: 0 4px 15px rgba(66, 132, 245, 0.1);
    }
    
    .role-section h2 {
      margin-top: 0;
      color: var(--primary-color);
      font-size: 1.5rem;
      border-bottom: 1px solid rgba(66, 132, 245, 0.2);
      padding-bottom: 10px;
    }

    .messages-container {
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    .message {
      margin-bottom: 1rem;
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      transition: transform 0.3s ease;
    }
    
    .message:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.12);
    }

    .user-message .message-header {
      background: var(--user-gradient);
    }
    
    .ai-message .message-header {
      background: var(--ai-gradient);
    }

    .message-header {
      padding: 1rem 1.5rem;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 500;
    }

    .reasoning-section {
      padding: 1.2rem 1.5rem;
      background: rgba(243, 156, 18, 0.1);
      border-left: 4px solid var(--reasoning-color);
      margin: 1rem 1.5rem;
      border-radius: 8px;
    }
    
    .reasoning-section h3 {
      margin-top: 0;
      color: var(--reasoning-color);
      font-size: 1.1rem;
    }

    .content-section {
      padding: 1.5rem;
      background: white;
    }
    
    .content-section h3 {
      margin-top: 0;
      color: #444;
      font-size: 1.1rem;
      border-bottom: 1px solid #eee;
      padding-bottom: 8px;
    }

    .timestamp {
      font-size: 0.9em;
      opacity: 0.8;
    }

    pre {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 8px;
      overflow-x: auto;
      margin: 1rem 0;
      border-left: 3px solid #ddd;
    }

    code {
      font-family: 'Fira Code', 'Consolas', monospace;
      font-size: 0.9em;
    }
    
    p code {
      background: rgba(0,0,0,0.05);
      padding: 0.2em 0.4em;
      border-radius: 3px;
      font-size: 0.9em;
    }
    
    .footer {
      text-align: center;
      margin-top: 3rem;
      padding: 1rem;
      color: #888;
      font-size: 0.9rem;
      border-top: 1px solid #eee;
    }
    
    @media (max-width: 768px) {
      body {
        padding: 1rem;
      }
      
      .header {
        padding: 1.5rem;
      }
      
      .message-header, .content-section, .reasoning-section {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>AI ÂØπËØùËÆ∞ÂΩï</h1>
    <p>ÂØºÂá∫Êó∂Èó¥: ${dateStr}</p>
  </div>`;

      // Ê∑ªÂä†ËßíËâ≤ËÆæÁΩÆ
      if (rolePrompt) {
        exportContent += `
  <div class="role-section">
    <h2>üí° ËßíËâ≤ËÆæÁΩÆ</h2>
    <div>${rolePrompt.replace(/\n/g, '<br>')}</div>
  </div>`;
      }

      exportContent += `
  <div class="messages-container">`;

      // Ê∑ªÂä†Ê∂àÊÅØÂÜÖÂÆπ
      messages.forEach(msg => {
        const role = msg.role === 'user' ? 'Áî®Êà∑' : 'AIÂä©Êâã';
        const messageClass = msg.role === 'user' ? 'user-message' : 'ai-message';
        const time = msg.timestamp ? new Date(msg.timestamp).toLocaleString() : 'Êú™Áü•Êó∂Èó¥';

        exportContent += `
    <div class="message ${messageClass}">
      <div class="message-header">
        <span>${role}</span>
        <span class="timestamp">${time}</span>
      </div>`;

        if (msg.thinkingContent) {
          exportContent += `
      <div class="reasoning-section">
        <h3>üí≠ ÊÄùËÄÉËøáÁ®ã</h3>
        <div>${msg.thinkingContent.replace(/\n/g, '<br>')}</div>
      </div>`;
        }

        exportContent += `
      <div class="content-section">
        <h3>üìù ÂÜÖÂÆπ</h3>
        <div>${msg.content.split('\n').join('<br>')
          .replace(/```([a-z]*)([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
          .replace(/`([^`]+)`/g, '<code>$1</code>')}</div>
      </div>
    </div>`;
      });

      exportContent += `
  </div>
  
  <div class="footer">
    Áî± MyChat AI Âä©ÊâãÁîüÊàê - ${new Date().getFullYear()}
  </div>
</body>
</html>`;
      break;

    case '2': // HTML Ê†ºÂºè
      exportContent = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI ÂØπËØùËÆ∞ÂΩï - ${dateStr}</title>
  <style>
    :root {
      --primary-color: #4284f5;
      --primary-gradient: linear-gradient(135deg, #4284f5, #42a5f5);
      --secondary-color: #f5f7fa;
      --reasoning-color: #f39c12;
      --user-gradient: linear-gradient(135deg, #e74c3c, #f39c12, #2c7a65);
      --ai-gradient: linear-gradient(135deg, #4284f5, #0097a7);
      --card-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
      --border-radius: 12px;
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      line-height: 1.8;
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem;
      background: var(--secondary-color);
      color: #333;
    }

    .header {
      text-align: center;
      margin-bottom: 3rem;
      padding: 2.5rem;
      background: var(--primary-gradient);
      color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      position: relative;
      overflow: hidden;
    }
    
    .header::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0) 70%);
      transform: rotate(30deg);
      z-index: 1;
    }
    
    .header h1 {
      position: relative;
      z-index: 2;
      margin-bottom: 1rem;
      font-size: 2.5rem;
    }
    
    .header p {
      position: relative;
      z-index: 2;
      opacity: 0.9;
    }

    .role-section {
      margin-bottom: 2.5rem;
      padding: 1.8rem;
      background: rgba(66, 132, 245, 0.1);
      border-radius: var(--border-radius);
      border-left: 5px solid var(--primary-color);
      box-shadow: 0 4px 15px rgba(66, 132, 245, 0.1);
    }
    
    .role-section h2 {
      margin-top: 0;
      color: var(--primary-color);
      font-size: 1.5rem;
      border-bottom: 1px solid rgba(66, 132, 245, 0.2);
      padding-bottom: 10px;
    }

    .messages-container {
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    .message {
      margin-bottom: 1rem;
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      transition: transform 0.3s ease;
    }
    
    .message:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.12);
    }

    .user-message .message-header {
      background: var(--user-gradient);
    }
    
    .ai-message .message-header {
      background: var(--ai-gradient);
    }

    .message-header {
      padding: 1rem 1.5rem;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 500;
    }

    .reasoning-section {
      padding: 1.2rem 1.5rem;
      background: rgba(243, 156, 18, 0.1);
      border-left: 4px solid var(--reasoning-color);
      margin: 1rem 1.5rem;
      border-radius: 8px;
    }
    
    .reasoning-section h3 {
      margin-top: 0;
      color: var(--reasoning-color);
      font-size: 1.1rem;
    }

    .content-section {
      padding: 1.5rem;
      background: white;
    }
    
    .content-section h3 {
      margin-top: 0;
      color: #444;
      font-size: 1.1rem;
      border-bottom: 1px solid #eee;
      padding-bottom: 8px;
    }

    .timestamp {
      font-size: 0.9em;
      opacity: 0.8;
    }

    pre {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 8px;
      overflow-x: auto;
      margin: 1rem 0;
      border-left: 3px solid #ddd;
    }

    code {
      font-family: 'Fira Code', 'Consolas', monospace;
      font-size: 0.9em;
    }
    
    p code {
      background: rgba(0,0,0,0.05);
      padding: 0.2em 0.4em;
      border-radius: 3px;
      font-size: 0.9em;
    }
    
    .footer {
      text-align: center;
      margin-top: 3rem;
      padding: 1rem;
      color: #888;
      font-size: 0.9rem;
      border-top: 1px solid #eee;
    }
    
    @media (max-width: 768px) {
      body {
        padding: 1rem;
      }
      
      .header {
        padding: 1.5rem;
      }
      
      .message-header, .content-section, .reasoning-section {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>AI ÂØπËØùËÆ∞ÂΩï</h1>
    <p>ÂØºÂá∫Êó∂Èó¥: ${dateStr}</p>
  </div>`;

      // Ê∑ªÂä†ËßíËâ≤ËÆæÁΩÆ
      if (rolePrompt) {
        exportContent += `
  <div class="role-section">
    <h2>üí° ËßíËâ≤ËÆæÁΩÆ</h2>
    <div>${rolePrompt.replace(/\n/g, '<br>')}</div>
  </div>`;
      }

      exportContent += `
  <div class="messages-container">`;

      // Ê∑ªÂä†Ê∂àÊÅØÂÜÖÂÆπ
      messages.forEach(msg => {
        const role = msg.role === 'user' ? 'Áî®Êà∑' : 'AIÂä©Êâã';
        const messageClass = msg.role === 'user' ? 'user-message' : 'ai-message';
        const time = msg.timestamp ? new Date(msg.timestamp).toLocaleString() : 'Êú™Áü•Êó∂Èó¥';

        exportContent += `
    <div class="message ${messageClass}">
      <div class="message-header">
        <span>${role}</span>
        <span class="timestamp">${time}</span>
      </div>`;

        if (msg.thinkingContent) {
          exportContent += `
      <div class="reasoning-section">
        <h3>üí≠ ÊÄùËÄÉËøáÁ®ã</h3>
        <div>${msg.thinkingContent.replace(/\n/g, '<br>')}</div>
      </div>`;
        }

        exportContent += `
      <div class="content-section">
        <h3>üìù ÂÜÖÂÆπ</h3>
        <div>${msg.content.split('\n').join('<br>')
          .replace(/```([a-z]*)([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
          .replace(/`([^`]+)`/g, '<code>$1</code>')}</div>
      </div>
    </div>`;
      });

      exportContent += `
  </div>
  
  <div class="footer">
    Áî± MyChat AI Âä©ÊâãÁîüÊàê - ${new Date().getFullYear()}
  </div>
</body>
</html>`;
      break;

    case '3': // Markdown Ê†ºÂºè
      exportContent = `# AI ÂØπËØùËÆ∞ÂΩï üìù

**üìÖ ÂØºÂá∫Êó∂Èó¥**: ${dateStr}

`;
      
      // Ê∑ªÂä†ËßíËâ≤ËÆæÁΩÆ
      if (rolePrompt) {
        exportContent += `## üí° ËßíËâ≤ËÆæÁΩÆ

${rolePrompt}

---

`;
      }
      
      // Ê∑ªÂä†Ê∂àÊÅØÂÜÖÂÆπ
      messages.forEach(msg => {
        const role = msg.role === 'user' ? 'üë§ **Áî®Êà∑**' : 'ü§ñ **AIÂä©Êâã**';
        const time = msg.timestamp ? new Date(msg.timestamp).toLocaleString() : 'Êú™Áü•Êó∂Èó¥';
        const emoji = msg.role === 'user' ? 'üí¨' : 'üîç';

        exportContent += `## ${emoji} ${role} ¬∑ *${time}*\n\n`;

        if (msg.thinkingContent) {
          exportContent += `### üí≠ ÊÄùËÄÉËøáÁ®ã\n\`\`\`\n${msg.thinkingContent}\n\`\`\`\n\n`;
        }

        exportContent += `### üìù ÂÜÖÂÆπ\n${msg.content}\n\n---\n\n`;
      });
      
      // Add footer
      exportContent += `\n\n*Áî± MyChat AI Âä©ÊâãÁîüÊàê - ${new Date().getFullYear()}*`;
      break;

    case '4': // JSON Ê†ºÂºè
      // ÊûÑÂª∫JSONÊ†ºÂºèÁöÑÂØºÂá∫ÂÜÖÂÆπÔºåÂåÖÊã¨ËßíËâ≤ËÆæÁΩÆ
      const exportData = {
        meta: {
          title: "AI ÂØπËØùËÆ∞ÂΩï",
          exportDate: dateStr,
          version: "2.0"
        },
        settings: {
          role: chat.roleData || null
        },
        messages: messages.map(msg => ({
          id: msg.id,
          role: msg.role,
          content: msg.content,
          thinkingContent: msg.thinkingContent || "",
          timestamp: msg.timestamp,
          hasThinking: !!msg.thinkingContent
        }))
      };
      
      exportContent = JSON.stringify(exportData, null, 2);
      break;

    default:
      ElMessage.warning('Êó†ÊïàÁöÑÈÄâÊã©');
      return;
  }

  // Á°ÆÂÆöÊñá‰ª∂Êâ©Â±ïÂêç
  const ext =
    format === '1' ? 'txt' :
    format === '2' ? 'html' :
    format === '3' ? 'md' : 'json';

  // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
  const blob = new Blob([exportContent], {
    type: format === '2' ? 'text/html' :
          format === '4' ? 'application/json' : 'text/plain;charset=utf-8'
  });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `AIÂØπËØùËÆ∞ÂΩï_${new Date().toISOString().slice(0, 10)}.${ext}`;
  document.body.appendChild(a);
  a.click();

  // Ê∏ÖÁêÜ
  setTimeout(() => {
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }, 100);
  
  ElMessage.success('ÂØπËØùÂ∑≤ÂØºÂá∫');
}

// Migration function to convert old chat history format to new format
const migrateOldChatHistory = () => {
  // Check if there's old chat history data to migrate
  const savedHistory = localStorage.getItem('chatHistory');
  if (!savedHistory) return;
  
  try {
    const oldChatHistory = JSON.parse(savedHistory);
    if (!Array.isArray(oldChatHistory) || oldChatHistory.length === 0) return;
    
    console.log(`Migrating ${oldChatHistory.length} old chat history records to new format...`);
    
    // Migrate each old chat history to the new format
    oldChatHistory.forEach(oldChat => {
      if (!oldChat.id || !oldChat.messages) return;
      
      // Create a new history record in the new format
      const record = {
        id: oldChat.id,
        title: oldChat.title || 'Untitled Chat',
        messages: JSON.parse(JSON.stringify(oldChat.messages)),
        timestamp: oldChat.createdAt || new Date().toISOString(),
        tokenCount: { prompt: 0, completion: 0, total: 0 } // Default token count
      };
      
      // Add the record if it doesn't already exist
      if (!historyStore.hasRecord(record.id)) {
        historyStore.addRecord(record);
      }
    });
    
    console.log('Migration complete. Removing old chat history data.');
    
    // Remove old data after successful migration
    localStorage.removeItem('chatHistory');
  } catch (error) {
    console.error('Error migrating old chat history:', error);
  }
};

// Add this after the Model selection dropdown but before the Temperature slider


// Add these variables to the script setup section
// Add this near where settingsForm is declared
const customModelInput = ref('');
const customModels = ref([]);

// Add this function to handle adding custom models
const addCustomModel = () => {
    if (customModelInput.value.trim()) {
        const newModel = {
            label: customModelInput.value.trim(),
            value: customModelInput.value.trim()
        };
        
        // Check if the model already exists
        const modelExists = modelOptions.value.some(model => 
            model.value === newModel.value
        );
        
        if (!modelExists) {
            // Add to settings store
            settingsStore.addModels([newModel.value]);
            customModels.value.push(newModel);
            ElMessage.success(`Added custom model: ${newModel.label}`);
            
            // Update local form if needed
            modelOptionsLastUpdated.value = Date.now();
            
            // Clear input field
            customModelInput.value = '';
        } else {
            ElMessage.warning('This model already exists in the list');
        }
    }
};

// Add this function to handle removing custom models
const removeCustomModel = (index) => {
    const modelToRemove = customModels.value[index];
    
    // First confirm with the user
    ElMessageBox.confirm(
        `Are you sure you want to remove the custom model "${modelToRemove.label}"?`,
        'Confirm Removal',
        {
            confirmButtonText: 'Yes, Remove',
            cancelButtonText: 'Cancel',
            type: 'warning'
        }
    ).then(() => {
        // Remove from the local list
        customModels.value.splice(index, 1);
        
        // We can't easily remove from the store's modelOptions,
        // but we can update the UI by forcing a refresh
        modelOptionsLastUpdated.value = Date.now();
        
        ElMessage.success(`Removed custom model: ${modelToRemove.label}`);
    }).catch(() => {
        // User cancelled, do nothing
    });
};

// Add CSS for the custom model input section
// Inside <style> section, add:

// Âú®ÁªÑ‰ª∂ÂàùÂßãÂåñÊó∂ÈáçÁΩÆÁä∂ÊÄÅ
onMounted(() => {
  // ÂàùÂßãÂåñÁä∂ÊÄÅ
  isStreamPaused.value = false;
  activeController.value = null;
  chatStore.isLoading = false;
  
  // Êó†ÈúÄÊâãÂä®Âä†ËΩΩÊ∂àÊÅØÔºåhistoryStore‰ºöËá™Âä®Âä†ËΩΩ
  console.log('[ChatView] Component mounted, states reset');
});

// Âú®ÁªÑ‰ª∂Âç∏ËΩΩÊó∂Ê∏ÖÁêÜÁä∂ÊÄÅ
onUnmounted(() => {
  // Â¶ÇÊûúÊúâÊ¥ªË∑ÉÁöÑËØ∑Ê±ÇÔºå‰∏≠Ê≠¢ÂÆÉ
  if (activeController.value) {
    activeController.value.abort();
    activeController.value = null;
  }
  
  // ÈáçÁΩÆÁä∂ÊÄÅ
  isStreamPaused.value = false;
  chatStore.isLoading = false;
});

</script>

<style lang="scss" scoped>
/* Êï¥‰ΩìÂÆπÂô®ÁªìÊûÑ */
.chat-view-container {
    display: flex;
    width: 100%;
    height: 100vh;
    position: relative;
    overflow: hidden;
    font-family: var(--font-family, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial);
    background-color: var(--bg-color, #f3f4f6);
    
    /* ÁßªÂä®Á´Ø‰ºòÂåñÈòÖËØªÂ≠ó‰Ωì */
    @media (max-width: 768px) {
        font-family: "Microsoft YaHei", "PingFang SC", "Heiti SC", "Noto Sans SC", -apple-system, BlinkMacSystemFont, sans-serif;
        font-weight: 400;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        letter-spacing: 0.015em;
    }
    
    &.sidebar-collapsed {
        .icon-sidebar {
            // ‰øùÊåÅÂéüÊ†∑
        }
        
        .sidebar {
            width: 0;
            padding: 0;
            overflow: hidden;
        }
        
        .main-chat-area {
            width: calc(100% - 52px); // Âè™ÂáèÂéªÂõæÊ†áÊ†èÁöÑÂÆΩÂ∫¶
        }
    }
}

// ÁßªÂä®Á´Ø‰æßËæπÊ†èÈÅÆÁΩ©
.mobile-sidebar-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 190; // ‰Ωé‰∫é‰æßËæπÊ†èÔºåÈ´ò‰∫éÂÖ∂‰ªñÂÜÖÂÆπ
    display: none;
    
    &.active {
        display: block; // ÊøÄÊ¥ªÊó∂ÊòæÁ§∫
        animation: fadeIn 0.3s ease;
    }
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* ‰∏ªËÅäÂ§©Âå∫ÂüüÊ†∑Âºè */
.main-chat-area {
    flex-grow: 1;
    width: calc(100% - 332px); // ÊÄªÂÆΩÂ∫¶ÂáèÂéª‰æßËæπÊ†è(280px)ÂíåÂõæÊ†áÊ†è(52px)
    height: 100%;
    display: flex;
    flex-direction: column;
    position: relative;
    transition: width 0.3s ease;
    
    @media (max-width: 768px) {
        width: 100%; // ÁßªÂä®Á´ØÂç†Êª°ÂÖ®Â±è
        height: 100vh; // ÊòéÁ°ÆËÆæÁΩÆÈ´òÂ∫¶
        margin-left: 0; // ÁßªÈô§Â∑¶ËæπË∑ùÔºåÁ°Æ‰øùÂÖ®Â±èÊòæÁ§∫
    }
    
    /* Ê∑ªÂä†ÊªöÂä®Âà∞Â∫ïÈÉ®ÊåâÈíÆ - ÁßªÂà∞main-chat-areaÂÜÖÈÉ® */
    .scroll-to-bottom-btn {
        position: fixed;
        bottom: 175px;
        left: 60%;
        transform: translateX(-50%);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: transparent;
        color: black;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: none;
        border: none;
        outline: none;
        transition: all 0.3s ease;
        opacity: 0;
        visibility: hidden;
        z-index: 100;
        pointer-events: auto;
        
        /* ËÄÉËôë‰æßËæπÊ†èÁä∂ÊÄÅ */
        .sidebar-collapsed & {
            left: calc(52px + (100% - 52px) / 2); /* ÂõæÊ†áÊ†èÂÆΩÂ∫¶ + Ââ©‰ΩôÂå∫ÂüüÁöÑ‰∏ÄÂçä */
        }
        
        &.visible {
            opacity: 1;
            visibility: visible;
            //animation: bounce 1s ease infinite;
        }
        
        &:hover {
            color: rgba(0, 0, 0, 0.8);
            transform: translateX(-50%) translateY(-2px);
        }
        
        &:active {
            transform: translateX(-50%) translateY(0);
        }
        
        svg {
            width: 24px;
            height: 24px;
            filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.2));
        }
        
        @media (max-width: 768px) {
            bottom: 100px;
            right: 16px;
            left: auto;
            transform: none;
            width: 36px;
            height: 36px;
            
            &:hover {
                transform: translateY(-2px);
            }
            
            &:active {
                transform: translateY(0);
            }
            
            svg {
                width: 22px;
                height: 22px;
            }
        }
    }
}

/* ËÅäÂ§©ÂÜÖÂÆπÂå∫Âüü */
.chat-content {
    flex-grow: 1;
    height: calc(100% - 135px); // ÁïôÂá∫Â§¥ÈÉ®ÂíåËæìÂÖ•Âå∫ÂüüÁöÑÁ©∫Èó¥
    overflow-y: auto;
    padding: 1.5rem;
    position: relative;
    display: flex;
    flex-direction: column;
    
    // Ëá™ÂÆö‰πâÊªöÂä®Êù°
    &::-webkit-scrollbar {
        width: 1px;
        height: 1px;
    }
    scrollbar-width: auto;
    
    &::-webkit-scrollbar-thumb {
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 3px;
    }
    
    &:hover::-webkit-scrollbar-thumb {
        background-color: rgba(0, 0, 0, 0.3);
    }
    
    @media (max-width: 768px) {
        padding: 1rem 0.75rem; // ÁßªÂä®Á´ØÂáèÂ∞èÂÜÖËæπË∑ùÔºåÂ¢ûÂä†ÂèØÁî®ÂÆΩÂ∫¶
        height: calc(100% - 120px); // Ë∞ÉÊï¥ÁßªÂä®Á´ØÈ´òÂ∫¶
    }
}

/* ËÅäÂ§©Ê∂àÊÅØÂå∫Âüü */
.message-list {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    max-width: 900px; // ÈôêÂà∂ÊúÄÂ§ßÂÆΩÂ∫¶Ôºå‰øùÊåÅÂèØËØªÊÄß
    margin: 0 auto; // Â±Ö‰∏≠ÊòæÁ§∫
    width: 100%; // Âç†Êª°ÂèØÁî®Á©∫Èó¥
    
    @media (max-width: 768px) {
        max-width: 100%; // ÁßªÂä®Á´ØÂç†Êª°ÂÆΩÂ∫¶
        margin: 0; // ÁßªÈô§ËæπË∑ùÔºåÂÖÖÂàÜÂà©Áî®Á©∫Èó¥
    }
}

// ËÅäÂ§©ËæìÂÖ•Âå∫Âüü
.modern-chat-input {
    padding: 0.75rem 1.5rem 1.5rem;
    position: relative;
    max-width: 900px;
    margin: 0 auto;
    width: 100%;
    
    @media (max-width: 768px) {
        padding: 0.5rem 0.75rem 1rem; // ÂáèÂ∞èÂÜÖËæπË∑ù
        max-width: 100%; // ÁßªÂä®Á´ØÂç†Êª°ÂÆΩÂ∫¶
    }
}

/* ÂûÇÁõ¥ÂõæÊ†áÊ†è */
.icon-sidebar {
    width: 60px;
    background-color: #202123;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 16px 0;
    // ÁßªÂä®Á´ØÈöêËóèÂõæÊ†áÊ†èÔºåÂêéÁª≠ÂèØÈÄöËøáÊåâÈíÆÊéßÂà∂ÊòæÁ§∫
    @media (max-width: 768px) {
        display: none; 
    }
    
    .icon-item {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #888;
        margin-bottom: 16px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        
        &:hover {
            background-color: #2d2d33;
            color: #fff;
        }
        
        &.main-icon {
            margin-bottom: 24px;
        }
        
        &.bottom-icon {
            margin-top: auto;
            margin-bottom: 0;
        }
        
        &.dark-mode-toggle {
            background-color: #2a2a30;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            
            .toggle-icon-wrapper {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 100%;
                height: 100%;
                transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            }
            
            .moon-icon, .sun-icon {
                filter: drop-shadow(0 0 2px rgba(255, 212, 59, 0.6));
            }
            
            &:hover {
                transform: scale(1.1);
                box-shadow: 0 0 8px rgba(255, 212, 59, 0.5);
            }
            
            &:after {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: radial-gradient(circle, rgba(255,212,59,0.2) 0%, rgba(255,212,59,0) 70%);
                opacity: 0;
                transition: opacity 0.3s;
            }
            
            &:hover:after {
                opacity: 1;
            }
            
            // Styles specific to dark mode active state
            &.dark-mode-active {
                background-color: #363640;
            }
        }
        
        .blue-avatar {
            background-color: white;
        }
    }
}

/* ‰æßËæπÊ†èÊ†∑Âºè */
.sidebar {
    width: 280px;
    background-color: #ffffff;
    display: flex;
    flex-direction: column;
    border-right: 1px solid #e5e7eb;
    overflow: hidden;
    transition: width 0.3s ease; // Ê∑ªÂä†ËøáÊ∏°ÊïàÊûú

    // ÁßªÂä®Á´ØÈöêËóè‰æßËæπÊ†èÔºåÂêéÁª≠ÂèØÈÄöËøáÊåâÈíÆÊéßÂà∂ÊòæÁ§∫
    @media (max-width: 768px) {
        position: fixed; // Êîπ‰∏∫fixedÔºå‰ΩøÂÖ∂ÂèØ‰ª•Ë¶ÜÁõñÂÜÖÂÆπ
        left: -280px; // ÈªòËÆ§ÈöêËóèÂú®Â∑¶‰æß
        top: 0;
        bottom: 0;
        height: 100%;
        z-index: 200; // ÊØîËÅäÂ§©ËæìÂÖ•Ê°ÜÈ´òÔºåÊØîÂèØËÉΩÁöÑÈÅÆÁΩ©Â±Ç‰Ωé
        box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        &.sidebar-open-mobile {
            left: 0; // ÊâìÂºÄÊó∂ÊªëÂÖ•
        }
    }
    
    /* ‰æßËæπÊ†èÂ§¥ÈÉ® */
    .sidebar-header {
        padding: 16px;
        
        .app-title {
            margin-bottom: 16px;
            display: flex;
            justify-content: center;
            align-items: center;
            
            .mac-controls {
                display: flex;
                gap: 8px;
                
                .mac-btn {
                    width: 12px;
                    height: 12px;
                    border-radius: 50%;
                    cursor: default;
                }
                
                .mac-close {
                    background-color: #ff5f56;
                }
                
                .mac-minimize {
                    background-color: #ffbd2e;
                }
                
                .mac-expand {
                    background-color: #27c93f;
                }
            }
        }
        
        .search-input {
            margin-bottom: 16px;
            
            :deep(.el-input__wrapper) {
                background-color: #f5f5f5;
                border-radius: 8px;
                box-shadow: none;
                padding: 6px 12px;
            }
            
            :deep(.el-input__inner) {
                font-size: 14px;
            }
        }
        
        .new-chat-wrapper {
            .new-chat-btn {
                width: 100%;
                border-radius: 8px;
                background-color: #202123;
                border: none;
                padding: 10px 0;
                font-size: 14px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                
                &:hover {
                    background-color: #353740;
                }
            }
        }
        
        /* ÁßªÂä®Á´ØÂäüËÉΩÊåâÈíÆÊ†∑Âºè */
        .mobile-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 16px;
            padding: 8px 0;
            border-top: 1px solid #f0f0f0;
            border-bottom: 1px solid #f0f0f0;
            
            [data-theme="dark"] & {
                border-color: #333;
            }
            
            .mobile-action-btn {
                flex: 1;
                padding: 8px;
                margin: 0 4px;
                border-radius: 8px;
                background-color: #f5f5f5;
                display: flex;
                align-items: center;
                justify-content: center;
                border: none;
                
                [data-theme="dark"] & {
                    background-color: #2d2d33;
                }
                
                &:hover {
                    background-color: #e8e8e8;
                    
                    [data-theme="dark"] & {
                        background-color: #383842;
                    }
                }
                
                .el-icon {
                    font-size: 16px;
                    color: #333;
                    
                    [data-theme="dark"] & {
                        color: #ddd;
                    }
                }
                
                &.theme-btn .el-icon {
                    color: #ffa500;
                }
                
                &.settings-btn .el-icon {
                    color: #4284f5;
                }
            }
        }
    }

    /* ‰æßËæπÊ†èÂàÜÁªÑ */
    .saved-chats, .history-group {
        padding: 0 16px;
        
        .sidebar-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
            
            .expand-icon {
                margin-left: auto;
                font-size: 12px;
                transition: transform 0.2s;
                
                &.collapsed {
                    transform: rotate(-90deg);
                }
            }
        }
    }
    
    .saved-chats {
        margin-bottom: 24px;
    }
}

/* ËÅäÂ§©È°πÁõÆ */
.chat-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    color: #333;
    transition: background-color 0.2s;
    margin-bottom: 4px;
    position: relative;
    
    .chat-icon {
        width: 24px;
        height: 24px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
        flex-shrink: 0;
    }
    
    .chat-title {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .more-btn {
        opacity: 0;
        transition: opacity 0.2s;
        padding: 2px;
        
        .el-icon {
            font-size: 16px;
            color: #666;
        }
    }
    
    &:hover {
        background-color: #f0f2f5;
        
        .more-btn {
            opacity: 1;
        }
    }
    
    &.active {
        background-color: #e6f4ff;
        color: #1677ff;
        font-weight: 500;
    }
}

/* ËÅäÂ§©Â§¥ÈÉ® */
.chat-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 24px;
    border-bottom: 1px solid #eaeaea;
    background-color: white;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
    position: relative;
    z-index: 10;
    
    // ÊöóÈªëÊ®°Âºè
    [data-theme="dark"] & {
        background-color: #202123;
        border-bottom-color: #333;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
    }

    // ÁßªÂä®Á´ØÊ†∑Âºè
    @media (max-width: 768px) {
        padding: 10px 12px;
    }

    // ÁßªÂä®Á´ØÂ∑¶‰æßÊåâÈíÆÁªÑ
    .header-left-actions {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 0 0 auto;
        .el-button.el-button--default.action-btn.theme-btn{
            margin-left: 0px;
            padding: 8px 10px;

            background-color: #f6f6f9;
            [data-theme="dark"] & {
                background-color: #2d2d33;
            }
        }
    }
    
    .mobile-menu-button {
        display: none; // ÈªòËÆ§ÈöêËóè
        background-color: transparent;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        padding: 8px;
        transition: background-color 0.2s ease;
        
        @media (max-width: 768px) {
            display: flex; // ÁßªÂä®Á´ØÊòæÁ§∫
            align-items: center;
            justify-content: center;
        }
        
        &:hover {
            background-color: rgba(0, 0, 0, 0.05);
            
            [data-theme="dark"] & {
                background-color: rgba(255, 255, 255, 0.1);
            }
        }
        
        img {
            width: 24px;
            height: 24px;
            
            [data-theme="dark"] & {
                filter: invert(1); // ÊöóËâ≤Ê®°Âºè‰∏ãÂèçËΩ¨È¢úËâ≤
            }
        }
    }
    
    // Â∑¶‰æßÂå∫Âüü
    .header-left {
        display: flex;
        align-items: center;
        gap: 12px;
        
        // ÁßªÂä®Á´ØÂ±Ö‰∏≠Ê†∑Âºè
        &.mobile-centered {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1;
        }
        
        .model-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #666;
            
            [data-theme="dark"] & {
                color: #aaa;
            }
        }
        
        // Removing duplicate model-tag styles as they're now properly defined inside model-info
    }
    
    // ‰∏≠Èó¥Ê†áÈ¢òÂå∫Âüü
    .header-center {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        max-width: 40%;
        text-align: center;
        
        .conversation-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            
            .conversation-title {
                font-size: 16px;
                font-weight: 600;
                color: #333;
                margin-bottom: 2px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 100%;
                
                [data-theme="dark"] & {
                    color: #e0e0e0;
                }
            }
            
            .conversation-stats {
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 12px;
                color: #666;
                
                [data-theme="dark"] & {
                    color: #aaa;
                }
                
                .stats-item {
                    display: flex;
                    align-items: center;
                    gap: 4px;
                    
                    .el-icon {
                        font-size: 12px;
                    }
                }
                
                .stats-divider {
                    color: #d1d5db;
                    
                    [data-theme="dark"] & {
                        color: #555;
                    }
                    margin-top: -2px;
                }
            }
        }
    }
    
    .model-info {
        display: flex;
        align-items: center;
        padding: 6px 10px;
        border-radius: 6px;
        transition: background-color 0.2s;
        background-color: #f9f9f9;
        
        [data-theme="dark"] & {
            background-color: #2d2d33;
        }
        
        &:hover {
            background-color: #f0f2f5;
            
            [data-theme="dark"] & {
                background-color: #383842;
            }
        }
        
        // ÁßªÂä®Á´ØÊ†∑Âºè
        @media (max-width: 768px) {
            padding: 4px 8px;
            min-width: 0;
            background-color: transparent;
            
            &:hover {
                background-color: transparent;
            }
        }
        
        .model-name {
            font-size: 15px;
            font-weight: 500;
            color: #333;
            
            [data-theme="dark"] & {
                color: #e0e0e0;
            }
            
            // ÁßªÂä®Á´ØÊ†∑Âºè - ÈôêÂà∂ÂÆΩÂ∫¶Èò≤Ê≠¢Ë∂ÖÈïø
            @media (max-width: 768px) {
                font-size: 13px;
                max-width: 130px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
        }
        .el-tag.el-tag--success.el-tag--small.el-tag--dark.model-tag {
    background: transparent;
    color: black;
    border: none;
}
        .model-tag {
            margin-left: 8px;
            height: auto;
            padding: 2px 8px;
            font-size: 11px;
            
            @media (max-width: 768px) {
                padding: 2px 6px;
                font-size: 10px;
            }
            
            .tag-content {
                display: flex;
                align-items: center;
                gap: 4px;
                
                .status-indicator {
                    width: 8px;
                    height: 8px;
                    border-radius: 50%;
                    
                    &.online {
                        background-color: #10b981;
                        box-shadow: 0 0 0 rgba(16, 185, 129, 0.4);
                        animation: pulse 2s infinite;
                    }
                }
            }
        }
        
        .model-dropdown-icon {
            margin-left: 6px;
            font-size: 12px;
            color: #909399;
            
            [data-theme="dark"] & {
                color: #aaa;
            }
            
            @media (max-width: 768px) {
                font-size: 10px;
                margin-left: 2px;
            }
        }
    }
    
    .header-actions {
        display: flex;
        gap: 8px;
        
        &.mobile-right-actions {
            flex: 0 0 auto;
            z-index: 2; // Á°Æ‰øùÊåâÈíÆÂú®Ê®°Âûã‰ø°ÊÅØ‰∏äÊñπÂèØÁÇπÂáª
        }
        
        .config-btn, .share-btn, .action-btn {
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            background-color: transparent;
            border: 1px solid #0000003b;
            color: #333;
            margin-left: 0px;
            
            [data-theme="dark"] & {
                background-color: #2d2d33;
                border-color: #444;
                color: #e0e0e0;
            }
            
            &:hover {
                background-color: #f0f2f5;
                
                [data-theme="dark"] & {
                    background-color: #383842;
                }
            }
            
            .el-icon {
                font-size: 14px;
            }
        }

        .theme-btn {
            padding: 8px 8px;
            transition: transform 0.3s;
            
            &:hover {
                transform: rotate(15deg);
            }
            
            [data-theme="dark"] & .el-icon {
                color: #FFD43B;
            }
        }
        
        .action-btn[type="primary"] {
            background-color: #4284f5;
            border-color: #4284f5;
            color: white;
            
            &:hover {
                background-color: #3472dc;
                border-color: #3472dc;
            }
            
            [data-theme="dark"] & {
                background-color: #4284f5;
                border-color: #3470db;
            }
        }
        
        @media (max-width: 768px) {
            gap: 4px; // ÂáèÂ∞èÊåâÈíÆÈó¥Ë∑ù
            
            .config-btn, .share-btn, .action-btn {
                padding: 8px !important; // ÂáèÂ∞èÂÜÖËæπË∑ù
                min-width: 36px !important; // Á°Æ‰øùÊåâÈíÆ‰∏ç‰ºöÂ§™Â∞è
                margin-left: 0px;
                border: none;
                
                // ÁßªÂä®Á´ØÈöêËóèÊåâÈíÆÊñáÂ≠óÔºåÂè™ÊòæÁ§∫ÂõæÊ†á
                .button-text {
                    display: none;
                }
                
                // Ë∞ÉÊï¥ÂõæÊ†áÂ§ßÂ∞è
                .el-icon {
                    font-size: 16px;
                    margin: 0;
                }
            }
        }
    }
}

@keyframes pulse {
    0% {
        box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
    }
    70% {
        box-shadow: 0 0 0 6px rgba(16, 185, 129, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
    }
}

/* Ê∂àÊÅØÂå∫Âüü */
.messages-container {
    flex: 1; // Âç†ÊçÆÂâ©‰ΩôÁ©∫Èó¥
    overflow-y: auto;
    padding: 16px 8px 20px; // Â∫ïÈÉ®ÁïôÂá∫‰∏Ä‰∫õÁ©∫Èó¥Ôºå‰ΩÜ‰∏ªË¶ÅÁî±ËæìÂÖ•Ê°ÜÈ´òÂ∫¶ÂÜ≥ÂÆö
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center; // Center child items horizontally
    
    @media (max-width: 768px) {
        padding: 12px 8px 10px;
        align-items: stretch; // Full width on mobile
    }

    &::-webkit-scrollbar {
        width: 6px;
    }
    
    &::-webkit-scrollbar-track {
        background: transparent;
    }
    
    &::-webkit-scrollbar-thumb {
        background-color: rgba(0,0,0,0.1);
        border-radius: 3px;
    }
    
    .empty-state {
        height: 100%;
        display: flex;
        justify-content: center;
        //padding-top: 80px;
    }
    
    /* Ê∑ªÂä†ÊªöÂä®Âà∞Â∫ïÈÉ®ÊåâÈíÆÊ†∑Âºè */
    .scroll-to-bottom-btn {
        position: absolute;
        bottom: 185px;
        left: 50%;
        transform: translateX(-50%);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: transparent;
        color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: none;
        border: none;
        outline: none;
        transition: all 0.3s ease;
        opacity: 0;
        visibility: hidden;
        z-index: 100;
        
        &.visible {
            opacity: 1;
            visibility: visible;
            animation: bounce 1s ease infinite;
        }
        
        &:hover {
            color: rgba(0, 0, 0, 0.8);
            transform: translateX(-50%) translateY(-2px);
        }
        
        &:active {
            transform: translateX(-50%) translateY(0);
        }
        
        svg {
            width: 24px;
            height: 24px;
            filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.2));
        }
        
        @media (max-width: 768px) {
            bottom: 100px;
            right: 16px;
            left: auto;
            transform: none;
            width: 36px;
            height: 36px;
            
            &:hover {
                transform: translateY(-2px);
            }
            
            &:active {
                transform: translateY(0);
            }
            
            svg {
                width: 22px;
                height: 22px;
            }
        }
    }
    
    .welcome-container {
        text-align: center;
        max-width: 800px;
        
        // ÁßªÂä®Á´ØÊ¨¢ËøéÈ°µÈÄÇÈÖç
        @media (max-width: 768px) {
            padding: 20px 10px;
            .welcome-title {
                font-size: 28px;
            }
            .welcome-subtitle {
                font-size: 14px;
            }
            .task-cards,
            .quick-actions {
                gap: 8px;
            }
        }
        
        .welcome-avatar {
            background-color: #4284f5;
            font-size: 40px;
            margin-bottom: 24px;
        }
        
        .welcome-title {
            font-size: 36px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #333;
        }
        
        .welcome-subtitle {
            font-size: 16px;
            color: #666;
            margin-bottom: 40px;
        }
        
        /* ‰ªªÂä°Âç°ÁâáÊ†∑Âºè */
        .task-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 40px;
            
            .task-card, .task-suggestions, .prompt-suggestion {
                flex: 1;
                min-width: 260px;
                background-color: #fafafa;
                border-radius: 12px;
                padding: 16px;
                text-align: left;
                box-shadow: 0 1px 3px rgba(0,0,0,0.05);
                 @media (max-width: 768px) {
                    min-width: calc(50% - 4px); // ÁßªÂä®Á´Ø‰∏ÄË°å‰∏§‰∏™
                    padding: 12px;
                }
            }
            
            .task-card {
                background-color: #202123;
                color: white;
                display: flex;
                gap: 12px;
                
                .task-card-content {
                    .task-card-header {
                        font-weight: 600;
                        margin-bottom: 6px;
                    }
                    
                    .task-card-description {
                        font-size: 13px;
                        opacity: 0.8;
                        line-height: 1.4;
                    }
                }
            }
            
            .task-suggestions {
                display: flex;
                flex-direction: column;
                
                .task-item {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    padding: 8px 0;
                    border-bottom: 1px solid #f0f0f0;
                    font-size: 14px;
                    color: #333;
                    
                    .el-icon {
                        color: #666;
                    }
                    
                    &:last-child {
                        border-bottom: none;
                    }
                }
                
                .task-footer {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-top: 12px;
                    
                    span {
                        font-size: 13px;
                        color: #666;
                    }
                }
            }
            
            .prompt-suggestion {
                .prompt-header {
                    display: flex;
                    
                    .prompt-text {
                        flex: 1;
                        font-size: 14px;
                        line-height: 1.5;
                        color: #333;
                    }
                    
                    .prompt-more {
                        color: #999;
                    }
                }
                
                .prompt-footer {
                    margin-top: 16px;
                    font-size: 13px;
                    color: #666;
                }
            }
        }
        
        /* Âø´ÈÄüÊìç‰ΩúÊåâÈíÆ */
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            margin-top: 40px;
            
            .action-button {
                border-radius: 20px;
                padding: 8px 16px;
                background-color: #f5f5f7;
                border: none;
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 14px;
                
                &:hover {
                    background-color: #eaeaec;
                }
                
                .el-icon {
                    font-size: 16px;
                    color: #666;
                }
                 @media (max-width: 768px) {
                    font-size: 12px;
                    padding: 6px 12px;
                }
            }
        }
    }
}

/* Ê∑ªÂä†Âä®ÁîªÊïàÊûú */
@keyframes bounce {
    0%, 100% {
        transform: translateY(0);
    }
    50% {
        transform: translateY(-5px);
    }
}

/* ËÅäÂ§©ËæìÂÖ•Ê°Ü */
.modern-chat-input {
    // Ëøô‰∏™Á±ªÁé∞Âú®‰∏ªË¶ÅÁî± ChatInput.vue ÂÜÖÈÉ®ÊéßÂà∂Ê†∑Âºè
    // Âú® ChatView.vue ‰∏≠ÔºåÂÆÉ‰ºöËá™ÁÑ∂Âú∞Â°´ÂÖÖ .main-chat-area ÁöÑÂÆΩÂ∫¶
    // ‰ΩÜÊàë‰ª¨ËøòÊòØÁªôÂÆÉ‰∏Ä‰∏™Âü∫Êú¨ÁöÑ‰∏ãËæπË∑ùÔºåÂ∞§ÂÖ∂ÊòØÂú®Ê≤°ÊúâÂÖ∂‰ªñÂÜÖÂÆπÊíëÂºÄÊó∂
    margin-bottom: 10px; 
    padding-left: 10px; // Â∑¶Âè≥Áïô‰∏Ä‰∫õËæπË∑ùÔºå‰ΩøÂÖ∂‰∏çÁ¥ßË¥¥ËæπÁºò
    padding-right: 10px;

    [data-theme="dark"] & {
      // Á°Æ‰øùÂú®ÊöóÈªëÊ®°Âºè‰∏ãÔºåÂ¶ÇÊûú ChatInput.vue Ê≤°ÊúâËÆæÁΩÆËÉåÊôØÔºåËøôÈáå‰∏ç‰ºöÊúâÂÜ≤Á™Å
    }
    
    @media (max-width: 768px) {
        margin-bottom: 0; // ÁßªÂä®Á´ØÂ∫ïÈÉ®ÈÄöÂ∏∏Ê≤°ÊúâÈ¢ùÂ§ñËæπË∑ù
        padding-left: 5px;
        padding-right: 5px;
    }
}

/* ÂÖçË¥£Â£∞Êòé */
.disclaimer {
    text-align: center;
    font-size: 12px;
    color: #888;
    padding: 12px;
    margin-bottom: 80px;
}

/* ËÆæÁΩÆÂØπËØùÊ°ÜÊ†∑Âºè */
:deep(.settings-dialog) {
    border-radius: 12px;
    overflow: hidden;
    
    .el-dialog__header {
        padding: 20px;
        margin: 0;
        border-bottom: 1px solid #f0f2f5;
        
        .el-dialog__title {
            font-size: 18px;
            font-weight: 600;
            margin-left: 40%;
        }
    }
    
    .el-dialog__body {
        padding: 24px;
        max-height: 60vh;
        overflow-y: auto;
        .el-divider__text.is-left{
        left: 25%;
        }
        
        &::-webkit-scrollbar {
            width: 1px;
        }
        scrollbar-width: auto;
        
        &::-webkit-scrollbar-track {
            background: transparent;
        }
        
        &::-webkit-scrollbar-thumb {
            background-color: rgba(0,0,0,0.1);
            border-radius: 3px;
        }
    }
    
    .el-dialog__footer {
        padding: 16px 20px;
        border-top: 1px solid #f0f2f5;
    }
    
    .settings-form {
        .el-divider {
            margin: 20px 0 16px;
        }
        
        :deep(.el-form-item) {
            margin-bottom: 16px;
        }
        
        :deep(.el-form-item__label) {
            font-size: 14px;
            color: #555;
        }
        
        .form-item-tip {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
            line-height: 1.4;
        }
        
        .w-full {
            width: 100%;
        }
        
        .current-role-info {
            padding: 12px;
            border-radius: 8px;
            background-color: #f9f9f9;
            
            .role-name {
                font-weight: 600;
                margin-bottom: 6px;
                color: #333;
            }
            
            .role-prompt {
                font-size: 12px;
                color: #666;
                margin-bottom: 8px;
                white-space: pre-wrap;
                line-height: 1.5;
                max-height: 100px;
                overflow-y: auto;
                scrollbar-width: none;
            }
        }
        
        .custom-model-input {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            
            .custom-model-field {
                flex: 1;
            }
        }
        
        .custom-models-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
            
            .custom-model-tag {
                margin-bottom: 4px;
                background-color: #f0f7ff;
                border-color: #d0e3ff;
                color: #4284f5;
                font-size: 12px;
                padding: 0 8px;
                height: 28px;
                line-height: 26px;
                transition: all 0.3s;
                
                .el-tag__close {
                    color: #4284f5;
                    
                    &:hover {
                        background-color: #4284f5;
                        color: white;
                    }
                }
                
                &:hover {
                    border-color: #4284f5;
                }
                
                [data-theme="dark"] & {
                    background-color: #2d3748;
                    border-color: #4a5568;
                    color: #90cdf4;
                }
            }
        }
    }
    
    .dialog-footer {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }
}

/* ‰∏∫ÈöèÊú∫È¢úËâ≤ÁîüÊàêÂáΩÊï∞ */
@function getRandomColor($id) {
    $colors: (
        #4284f5, #34a853, #fdbc40, #ed5a5a, #8150e4, 
        #f07922, #0097a7, #d32f2f, #039be5, #7cb342
    );
    @return nth($colors, ($id % 10) + 1);
}

/* ÊöóËâ≤Ê®°ÂºèË∞ÉÊï¥ */
[data-theme="dark"] {
    .chat-view-container {
        background-color: #1a1a1a;
    }
    
    .sidebar {
        background-color: #202123;
        border-color: #333;
        
        .sidebar-header {
            .app-title {
                color: #fff;
                
                .mac-btn {
                    box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.1) inset;
                }
            }
            
            .search-input {
                :deep(.el-input__wrapper) {
                    background-color: #2d2d33;
                }
                
                :deep(.el-input__inner) {
                    color: #ddd;
                }
            }
        }
        
        .sidebar-label {
            color: #aaa;
        }
    }
    
    .chat-item {
        color: #ddd;
        
        &:hover {
            background-color: #2d2d33;
        }
        
        &.active {
            background-color: #2d2d33;
            color: #4284f5;
        }
        
        .more-btn .el-icon {
            color: #aaa;
        }
    }
    
    .main-chat-area {
        background-color: #1a1a1a;
    }
    
    .chat-header {
        background-color: #202123;
        border-color: #333;
     
        .model-info .model-name {
            color: #ddd;
          
        }
        
        .header-actions {
            .config-btn, .share-btn, .action-btn {
                background-color: #2d2d33;
                border-color: #444;
                color: #ddd;
                
                &:hover {
                    background-color: #353740;
                }
            }
        }
    }
    
    .messages-container {
        .welcome-container {
            padding-top:0px;
            .welcome-title {
                color: #ddd;
            }
            
            .welcome-subtitle {
                color: #aaa;
            }
            
            .task-suggestions {
                background-color: #2d2d33;
                
                .task-item {
                    border-color: #444;
                    color: #ddd;
                    
                    .el-icon {
                        color: #aaa;
                    }
                }
                
                .task-footer span {
                    color: #aaa;
                }
            }
            
            .prompt-suggestion {
                background-color: #2d2d33;
                
                .prompt-header .prompt-text {
                    color: #ddd;
                }
                
                .prompt-footer {
                    color: #aaa;
                }
            }
            
            .quick-actions .action-button {
                background-color: #2d2d33;
                color: #ddd;
                
                &:hover {
                    background-color: #353740;
                }
                
                .el-icon {
                    color: #aaa;
                }
            }
        }
        
        .scroll-to-bottom-btn {
            background-color: transparent;
            color: rgba(255, 255, 255, 0.6);
            border: none;
            outline: none;
            box-shadow: none;
            
            &:hover {
                color: rgba(255, 255, 255, 0.9);
                background-color: transparent;
            }
            
            svg {
                filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
            }
        }
    }
    
    .modern-chat-input {
        background-color: transparent;
    }
    
    .disclaimer {
        color: #777;
    }
    
    :deep(.settings-dialog) {
        background-color: #202123;
        
        .el-dialog__header {
            border-color: #333;
        }
        
        .el-dialog__footer {
            border-color: #333;
        }
        
        .settings-form {
            :deep(.el-form-item__label) {
                color: #aaa;
            }
            
            .form-item-tip {
                color: #777;
            }
            
            .current-role-info {
                background-color: #2d2d33;
                
                .role-name {
                    color: #ddd;
                }
                
                .role-prompt {
                    color: #aaa;
                }
            }
        }
    }
}

// Âú®ÈÄÇÂΩì‰ΩçÁΩÆÊ∑ªÂä†Ê∑±Â∫¶ÊÄùËÄÉÁöÑÊ†∑Âºè
:deep(.chat-message) {
    .thinking-content {
        margin-top: 12px;
        padding: 12px 16px;
        background-color: #f5f5f5;
        border-radius: 8px;
        position: relative;
        
        .thinking-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-weight: 500;
            color: #666;
            
            .thinking-icon {
                color: #4284f5;
             
            }
        }
        
        .thinking-text {
            font-size: 14px;
            line-height: 1.6;
            color: #666;
            white-space: pre-wrap;
        }
    }
}

:deep(.el-dropdown-menu) {
    .el-dropdown-item.is-active {
        color: #4284f5;
        background-color: #ecf5ff;
    }
    
    [data-theme="dark"] & .el-dropdown-item.is-active {
        color: #4284f5;
        background-color: #2d2d33;
    }
}

.parse-models-btn {
    margin-top: 8px;
    width: 100%;
}

/* ËøîÂõûÈ°∂ÈÉ®ÊåâÈíÆ */
.scroll-to-top {
  position: fixed;
  bottom: 100px;
  right: 20px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background-color: rgba(0, 0, 0, 0.5);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
  z-index: 100;

  &.visible {
    opacity: 1;
    visibility: visible;
  }

  &:hover {
    background-color: rgba(0, 0, 0, 0.7);
  }

  svg {
    width: 24px;
    height: 24px;
  }
}

// Add the custom model styles in the correct location - at the beginning of the style section
.custom-model-input {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
    
    .custom-model-field {
        flex: 1;
    }
}

.custom-models-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 12px;
    
    .custom-model-tag {
        margin-bottom: 4px;
    }
  svg {
    width: 24px;
    height: 24px;
  }
}
</style>
<!-- <script>
document.querySelector('.toggle-thinking-btn').addEventListener('click', function() {
    var thinkingHeader = document.getElementById('thinking-header');
    thinkingHeader.style.backgroundColor = 'lightblue';  // ‰øÆÊîπÈ¢úËâ≤
  });
</script>    -->
<!-- <script>
document.querySelector('.toggle-thinking-btn').addEventListener('click', function() {
    var thinkingHeader = document.getElementById('thinking-header');
    thinkingHeader.style.backgroundColor = 'lightblue';  // ‰øÆÊîπÈ¢úËâ≤
  });
</script>    -->
  

